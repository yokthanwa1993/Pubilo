<!doctype html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>FewFeed - Facebook One Card Link Image Post</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    sans-serif;
                background: #f8f9fa;
                color: #1a1a1a;
                line-height: 1.5;
                min-height: 100vh;
            }

            /* Header */
            .header {
                background: #fff;
                border-bottom: 1px solid #e5e5e5;
                padding: 0.75rem 1.5rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 100;
                height: 60px;
            }

            .logo {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 1.25rem;
                font-weight: 700;
                color: #7c3aed;
            }

            .logo svg {
                width: 28px;
                height: 28px;
            }

            .logo span {
                color: #a78bfa;
                font-weight: 400;
                font-size: 0.875rem;
            }

            .header-right {
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .status-indicators {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .status-indicator {
                display: flex;
                align-items: center;
                gap: 0.25rem;
                padding: 0.375rem 0.625rem;
                border-radius: 6px;
                font-size: 0.75rem;
                font-weight: 500;
                background: #f3f4f6;
            }

            .status-indicator svg {
                width: 16px;
                height: 16px;
            }

            .status-indicator.valid {
                background: #dcfce7;
                color: #166534;
            }

            .status-indicator.valid svg {
                color: #22c55e;
            }

            .status-indicator.invalid {
                background: #fee2e2;
                color: #991b1b;
            }

            .status-indicator.invalid svg {
                color: #ef4444;
            }

            .user-avatar {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                background: #7c3aed;
                color: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                font-size: 0.875rem;
                overflow: hidden;
                position: relative;
            }

            .user-avatar #headerAvatarInitial {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
            }

            /* Main Layout with Sidebar */
            .app-layout {
                display: block;
                min-height: calc(100vh - 60px);
                padding: 0.5rem;
                padding-left: calc(280px + 1rem);
                padding-top: calc(60px + 0.5rem);
                background: #f8f9fa;
            }

            /* Only apply to Link/Image mode panels */
            .app-layout:not(.pending-mode) > .sidebar,
            .app-layout:not(.pending-mode) > .main-content {
                min-height: 0;
            }

            /* Pending mode - allow content to grow with table */
            .app-layout.pending-mode {
                align-items: stretch;
            }
            .app-layout.pending-mode > .main-content {
                height: auto;
            }

            /* Sidebar */
            .sidebar {
                width: 280px;
                min-width: 280px;
                max-width: 280px;
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                height: calc(100vh - 60px - 1rem);
                position: fixed;
                top: calc(60px + 0.5rem);
                left: 0.5rem;
                overflow-y: auto;
            }

            .sidebar-page-selector {
                padding: 1rem;
                padding-bottom: 0.5rem;
                position: relative;
                background: #fff;
                border-radius: 12px 12px 0 0;
            }

            .sidebar-page-selector .page-selector {
                width: 100%;
            }

            .sidebar-page-selector .page-dropdown {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                z-index: 100;
            }

            .sidebar-nav {
                padding: 1rem;
                padding-top: 0.5rem;
                background: #fff;
                border-radius: 0 0 12px 12px;
                flex: 1;
                overflow-y: auto;
            }

            .sidebar-page-selector,
            .sidebar-nav {
                box-shadow: none;
            }

            .sidebar {
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            }

            .nav-section {
                padding: 0;
                margin-bottom: 1.25rem;
            }

            .nav-section-title {
                font-size: 0.6875rem;
                font-weight: 600;
                color: #9ca3af;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                padding: 0 0.5rem;
                margin-bottom: 0.5rem;
            }

            .nav-item {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.625rem 0.75rem;
                border-radius: 8px;
                font-size: 0.875rem;
                color: #4b5563;
                cursor: pointer;
                transition: all 0.15s;
                text-decoration: none;
            }

            .nav-item:hover {
                background: #f3f4f6;
                color: #1a1a1a;
            }

            .nav-item.active {
                background: #f3e8ff;
                color: #7c3aed;
            }

            .nav-item svg {
                width: 18px;
                height: 18px;
                flex-shrink: 0;
            }

            .nav-item .badge {
                margin-left: auto;
                background: #7c3aed;
                color: #fff;
                font-size: 0.6875rem;
                font-weight: 600;
                padding: 0.125rem 0.5rem;
                border-radius: 10px;
            }

            .sidebar-footer {
                padding: 1rem;
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            }

            .sidebar-user {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.5rem;
                border-radius: 8px;
                cursor: pointer;
            }

            .sidebar-user:hover {
                background: #f3f4f6;
            }

            .sidebar-user-avatar {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: #fff;
                font-weight: 600;
                font-size: 0.875rem;
            }

            .sidebar-user-info h4 {
                font-size: 0.8125rem;
                font-weight: 600;
                color: #1a1a1a;
            }

            .sidebar-user-info p {
                font-size: 0.6875rem;
                color: #6b7280;
            }

            /* Main Content */
            .main-content {
                display: flex;
                gap: 1rem;
                align-items: stretch;
                min-height: 0;
                height: min(560px, calc(100vh - 240px));
            }

            /* Preview Panel - Center */
            .preview-panel {
                height: min(560px, calc(100vh - 240px));
                display: flex;
                flex-direction: column;
                flex-shrink: 0;
            }

            .card-preview-header {
                display: flex;
                align-items: center;
                justify-content: flex-end;
                padding: 1rem;
                gap: 0.75rem;
            }

            .preview-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: #1877f2;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #fff;
                font-weight: 600;
            }

            .preview-avatar-img {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
                background: #e5e5e5;
            }

            .page-selector {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.5rem 0.75rem;
                border-radius: 8px;
                cursor: pointer;
                transition: background 0.15s;
                position: relative;
            }

            .page-selector:hover {
                background: #f3f4f6;
            }

            .page-selector-skeleton {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
                background: #f3f4f6;
                border-radius: 8px;
            }

            .page-selector-skeleton .sk-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: #e5e5e5;
            }

            .page-selector-skeleton .sk-lines {
                display: flex;
                flex-direction: column;
                gap: 6px;
                flex: 1;
            }

            .page-selector-skeleton .sk-line {
                height: 12px;
                background: #e5e5e5;
                border-radius: 4px;
            }

            .page-selector-skeleton .sk-line:first-child {
                width: 100px;
            }

            .page-selector-skeleton .sk-line:last-child {
                width: 140px;
            }

            .page-dropdown-icon {
                width: 16px;
                height: 16px;
                color: #6b7280;
                margin-left: 0.25rem;
            }

            .page-dropdown {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                min-width: 280px;
                max-height: 300px;
                overflow-y: auto;
                z-index: 1000;
                margin-top: 4px;
            }

            .page-dropdown.visible {
                display: block;
            }

            .page-dropdown-item {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
                cursor: pointer;
                transition: background 0.15s;
            }

            .page-dropdown-item:hover {
                background: #f3f4f6;
            }

            .page-dropdown-item.selected {
                background: #f3e8ff;
            }

            .page-dropdown-item img {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                object-fit: cover;
            }

            .page-dropdown-item-info h4 {
                font-size: 0.875rem;
                font-weight: 600;
                color: #1a1a1a;
            }

            .page-dropdown-item-info p {
                font-size: 0.75rem;
                color: #6b7280;
            }

            .preview-page-info h3 {
                font-size: 0.9375rem;
                font-weight: 600;
                color: #1a1a1a;
            }

            .preview-page-info p {
                font-size: 0.75rem;
                color: #6b7280;
            }

            .btn-publish {
                background: #1f2937;
                color: #fff;
                border: none;
                padding: 0.625rem 1.5rem;
                border-radius: 8px;
                font-size: 0.875rem;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s;
            }

            .btn-publish:hover {
                background: #111827;
            }

            .btn-publish:disabled {
                background: #9ca3af;
                cursor: not-allowed;
            }

            .btn-publish.published {
                background: #10b981;
                cursor: pointer;
            }

            .btn-publish.published:hover {
                background: #059669;
            }

            /* Card Preview - Fixed height container for all modes */
            .card-preview {
                background: #fff;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                height: min(560px, calc(100vh - 240px));
                display: flex;
                flex-direction: column;
            }

            /* Card image area - default, will be overridden per mode */
            .card-image-area {
                background: #1a1a1a;
                position: relative;
                cursor: pointer;
                overflow: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Mode Containers - show/hide based on active state */
            .mode-container {
                display: none;
                width: 100%;
                gap: 1.5rem;
            }

            .mode-container.active {
                display: flex;
            }

            /* Link mode: 1:1 - square image + link info below */
            #linkModeContainer .card-preview {
                width: auto;
            }

            #linkModeContainer .card-image-area {
                aspect-ratio: 1 / 1;
                width: auto;
                height: calc(100% - 80px); /* Leave space for link info */
            }

            #linkModeContainer .card-link-info {
                height: 80px;
                width: 100%;
                flex-shrink: 0;
            }
            
            /* Image mode: 2:3 - full height image */
            #imageModeContainer .card-preview {
                width: auto;
            }

            #imageModeContainer .card-image-area {
                aspect-ratio: 2 / 3;
                width: auto;
                height: 100%;
            }

            #imageModeContainer .form-panel {
                flex: 1;
                min-width: 400px;
            }

            /* Reels mode: 9:16 - full height image */
            #reelsModeContainer .card-preview {
                width: auto;
            }

            #reelsModeContainer .card-image-area {
                aspect-ratio: 9 / 16;
                width: auto;
                height: 100%;
            }

            #reelsModeContainer .form-panel {
                flex: 1;
                min-width: 400px;
            }

            /* Stack upload buttons vertically in Reels/Image mode */
            #reelsModeContainer .upload-buttons,
            #imageModeContainer .upload-buttons {
                flex-direction: column;
            }

            .upload-prompt {
                position: absolute;
                inset: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: #6b7280;
                gap: 0.5rem;
            }

            .upload-buttons {
                display: flex;
                gap: 1rem;
            }

            .upload-btn {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.75rem;
                padding: 1.5rem 2rem;
                border: 2px dashed #4b5563;
                border-radius: 12px;
                background: rgba(75, 85, 99, 0.1);
                color: #9ca3af;
                cursor: pointer;
                transition: all 0.2s;
                min-width: 140px;
            }

            .upload-btn:hover {
                border-color: #8b5cf6;
                background: rgba(139, 92, 246, 0.1);
                color: #8b5cf6;
            }

            .upload-btn svg {
                width: 32px;
                height: 32px;
            }

            .upload-btn span {
                font-size: 0.875rem;
                font-weight: 500;
            }

            .upload-from-gemini:hover {
                border-color: #f97316;
                background: rgba(249, 115, 22, 0.1);
                color: #f97316;
            }

            .upload-prompt svg {
                width: 48px;
                height: 48px;
                color: #4b5563;
            }

            .upload-prompt span {
                font-size: 0.875rem;
            }

            .generate-overlay {
                position: absolute;
                inset: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background: rgba(0, 0, 0, 0.5);
            }

            .btn-generate {
                background: #f97316;
                color: #fff;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 8px;
                font-size: 0.9375rem;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .btn-generate:hover {
                background: #ea580c;
            }

            .btn-generate:disabled {
                background: #9ca3af;
                cursor: not-allowed;
            }

            .ref-thumbs-row {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, 0.8);
                padding: 0.75rem;
                display: flex;
                gap: 0.5rem;
                overflow-x: auto;
            }

            .ref-thumb {
                width: 48px;
                height: 48px;
                border-radius: 6px;
                object-fit: cover;
                border: 2px solid transparent;
                flex-shrink: 0;
            }

            .ref-thumb:last-child {
                width: 48px;
                height: 48px;
                background: rgba(255, 255, 255, 0.1);
                border: 2px dashed #6b7280;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #6b7280;
                cursor: pointer;
            }

            .generated-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                width: 100%;
                height: 100%;
                padding: 8px;
                background: #1a1a1a;
                position: relative;
            }

            .btn-regenerate {
                position: absolute;
                top: 12px;
                right: 12px;
                background: rgba(249, 115, 22, 0.9);
                color: #fff;
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                font-size: 0.75rem;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                z-index: 10;
            }

            .btn-regenerate:hover {
                background: #ea580c;
            }

            .generated-item {
                position: relative;
                border-radius: 8px;
                overflow: hidden;
                cursor: pointer;
                border: 3px solid transparent;
            }

            .generated-item:hover {
                border-color: #7c3aed;
            }

            .generated-item.selected {
                border-color: #10b981;
            }

            .generated-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .generated-item .item-number {
                position: absolute;
                top: 8px;
                left: 8px;
                background: rgba(0, 0, 0, 0.7);
                color: #fff;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.75rem;
                font-weight: 600;
            }

            .skeleton-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                width: 100%;
                height: 100%;
                padding: 8px;
                background: #1a1a1a;
            }

            .skeleton-grid.single {
                grid-template-columns: 1fr;
                padding: 0;
            }

            .skeleton-grid.single .skeleton-card {
                border-radius: 0;
            }

            .skeleton-card {
                background: #2a2a2a;
                border-radius: 8px;
                position: relative;
                overflow: hidden;
            }

            .skeleton-card::after {
                content: "";
                position: absolute;
                inset: 0;
                background: linear-gradient(
                    90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.05) 50%,
                    transparent 100%
                );
                background-size: 200% 100%;
                animation: skeleton-shimmer 1.5s infinite;
            }

            @keyframes skeleton-shimmer {
                0% {
                    background-position: 200% 0;
                }

                100% {
                    background-position: -200% 0;
                }
            }

            .card-link-info {
                display: flex;
                align-items: center;
                padding: 1rem 1.25rem;
                gap: 0.75rem;
                border-top: 1px solid #e5e5e5;
            }

            .card-link-details {
                flex: 1;
                min-width: 0;
                overflow: hidden;
            }

            .card-link-caption {
                font-size: 0.7rem;
                color: #6b7280;
                text-transform: uppercase;
                margin-bottom: 0.15rem;
            }

            .card-link-title {
                font-size: 0.9rem;
                font-weight: 400;
                color: #1a1a1a;
                margin-bottom: 0.1rem;
                word-break: break-all;
                white-space: normal;
                display: flex;
                flex-wrap: wrap;
            }

            .card-link-description {
                font-size: 0.8125rem;
                color: #6b7280;
                display: flex;
                align-items: center;
            }

            .description-prefix {
                color: #6b7280;
                pointer-events: none;
                user-select: none;
            }

            #previewDescription {
                min-height: 1.2em;
                cursor: text;
                color: #6b7280;
                word-break: break-all;
                flex: 1;
                min-width: 0;
            }

            #previewDescription:empty::after {
                content: "___";
                color: transparent;
            }

            .card-button-wrapper {
                position: relative;
            }

            .btn-learn-more {
                background: #f3f4f6;
                border: 1px solid #e5e5e5;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                font-size: 0.8125rem;
                font-weight: 500;
                color: #374151;
                cursor: pointer;
                white-space: nowrap;
                display: flex;
                align-items: center;
                gap: 0.25rem;
            }

            .btn-learn-more:hover {
                background: #e5e7eb;
                border-color: #d1d5db;
            }

            .btn-learn-more::after {
                content: "â–¼";
                font-size: 0.5rem;
                opacity: 0.6;
            }

            .card-button-dropdown {
                position: absolute;
                bottom: 100%;
                left: 0;
                margin-bottom: 4px;
                background: white;
                border: 1px solid #e5e5e5;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                min-width: 120px;
                overflow: hidden;
                z-index: 100;
                display: none;
            }

            .card-button-dropdown.show {
                display: block;
            }

            .card-button-option {
                padding: 0.5rem 0.75rem;
                font-size: 0.8125rem;
                color: #374151;
                cursor: pointer;
                transition: background 0.15s;
            }

            .card-button-option:hover {
                background: #f3f4f6;
            }

            .card-button-option.selected {
                background: #1f2937;
                color: white;
            }

            .card-button-option.selected:hover {
                background: #111827;
            }

            /* Full Image View */
            .full-image-view {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
            }

            .full-image-view img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }

            .back-to-grid {
                position: absolute;
                top: 12px;
                left: 12px;
                background: rgba(0, 0, 0, 0.7);
                color: #fff;
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                font-size: 0.75rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .back-to-grid:hover {
                background: rgba(0, 0, 0, 0.9);
            }

            /* Right Panel - Form - Same height as card-preview */
            .form-panel {
                min-width: 400px;
                display: flex;
                flex-direction: column;
                height: 100%;
                flex: 1;
            }

            .card {
                background: #fff;
                border-radius: 12px;
                padding: 1.25rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                flex: 1 1 auto;
                min-height: 0;
                height: 100%;
                overflow-y: auto;
            }

            .card-title {
                font-size: 0.875rem;
                font-weight: 600;
                color: #1a1a1a;
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
                border-bottom: 1px solid #f0f0f0;
            }

            .form-group {
                margin-bottom: 1rem;
            }

            .form-group:last-child {
                margin-bottom: 0;
            }

            .form-label {
                display: block;
                font-size: 0.8125rem;
                font-weight: 500;
                color: #374151;
                margin-bottom: 0.5rem;
            }

            .form-select,
            .form-input,
            .form-textarea {
                width: 100%;
                padding: 0.625rem 0.875rem;
                border: 1px solid #e5e5e5;
                border-radius: 8px;
                font-size: 0.875rem;
                font-family: inherit;
                background: #fff;
                color: #1a1a1a;
                transition:
                    border-color 0.2s,
                    box-shadow 0.2s;
            }

            .form-select:focus,
            .form-input:focus,
            .form-textarea:focus {
                outline: none;
                border-color: #7c3aed;
                box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
            }

            .form-textarea {
                resize: vertical;
                min-height: 80px;
            }

            .form-select {
                cursor: pointer;
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 0.75rem center;
                background-size: 1rem;
                padding-right: 2.5rem;
            }

            .checkbox-group {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            .checkbox-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
            }

            .checkbox-item input {
                width: 18px;
                height: 18px;
                accent-color: #7c3aed;
            }

            .checkbox-item label {
                font-size: 0.875rem;
                color: #374151;
                cursor: pointer;
            }

            .schedule-row {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 0.75rem;
            }

            .schedule-label {
                font-size: 0.875rem;
                font-weight: 500;
                color: #374151;
            }

            .toggle {
                position: relative;
                width: 44px;
                height: 24px;
            }

            .toggle input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .toggle-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #e5e5e5;
                border-radius: 24px;
                transition: 0.3s;
            }

            .toggle-slider:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 3px;
                bottom: 3px;
                background: #fff;
                border-radius: 50%;
                transition: 0.3s;
            }

            .toggle input:checked + .toggle-slider {
                background: #f97316;
            }

            .toggle input:checked + .toggle-slider:before {
                transform: translateX(20px);
            }

            /* Loading */
            .loading {
                display: inline-block;
                width: 18px;
                height: 18px;
                border: 2px solid #fff;
                border-radius: 50%;
                border-top-color: transparent;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* Responsive */
            @media (max-width: 1400px) {
                .sidebar {
                    width: 280px;
                }

                .form-panel {
                    min-width: 320px;
                }

                .preview-panel {
                    --image-size: min(420px, calc(100vh - 297px));
                }
            }

            @media (max-width: 1024px) {
                .app-layout {
                    grid-template-columns: 1fr;
                    justify-items: center;
                }

                .sidebar {
                    width: 100%;
                    max-width: 460px;
                }

                .preview-panel {
                    --image-size: min(460px, 90vw);
                    width: var(--image-size);
                    max-width: 460px;
                }

                .form-panel {
                    width: 100%;
                    max-width: 460px;
                }

                .pending-panel {
                    width: 100%;
                }
            }

            /* Settings Modal */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .modal {
                background: #fff;
                border-radius: 12px;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            }

            .modal-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 1rem 1.25rem;
                border-bottom: 1px solid #e5e5e5;
            }

            .modal-header h3 {
                font-size: 1.125rem;
                font-weight: 600;
            }

            .modal-close {
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #6b7280;
                line-height: 1;
            }

            .modal-body {
                padding: 1.25rem;
            }

            .modal-footer {
                padding: 1rem 1.25rem;
                border-top: 1px solid #e5e5e5;
                display: flex;
                justify-content: flex-end;
            }

            .setting-group {
                margin-bottom: 1rem;
            }

            .setting-label {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-weight: 500;
                cursor: pointer;
            }

            .setting-label input[type="checkbox"] {
                width: 18px;
                height: 18px;
                accent-color: #7c3aed;
            }

            .setting-desc {
                font-size: 0.75rem;
                color: #6b7280;
                margin-top: 0.25rem;
                margin-left: 1.625rem;
            }

            .radio-group {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .radio-option {
                display: flex;
                align-items: center;
                gap: 0.35rem;
                padding: 0.4rem 0.75rem;
                background: #f3f4f6;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.875rem;
                transition: all 0.15s;
            }

            .radio-option:hover {
                background: #e5e7eb;
            }

            .radio-option:has(input:checked) {
                background: #7c3aed;
                color: #fff;
            }

            .radio-option input[type="radio"] {
                display: none;
            }

            .next-schedule-display {
                background: #f3e8ff;
                color: #7c3aed;
                padding: 0.5rem 0.75rem;
                border-radius: 6px;
                font-weight: 500;
            }

            .btn-save {
                background: #7c3aed;
                color: #fff;
                border: none;
                padding: 0.625rem 1.25rem;
                border-radius: 8px;
                font-weight: 500;
                cursor: pointer;
            }

            .btn-save:hover {
                background: #6d28d9;
            }

            /* Pending list */
            .pending-item {
                display: flex;
                gap: 0.75rem;
                padding: 0.75rem;
                background: #f9fafb;
                border-radius: 8px;
                margin-bottom: 0.5rem;
            }

            .pending-item-thumb {
                width: 48px;
                height: 48px;
                border-radius: 6px;
                object-fit: cover;
                background: #e5e5e5;
            }

            .pending-item-info {
                flex: 1;
                min-width: 0;
            }

            .pending-item-title {
                font-weight: 500;
                font-size: 0.875rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .pending-item-time {
                font-size: 0.75rem;
                color: #6b7280;
            }

            .pending-item-delete {
                background: none;
                border: none;
                color: #ef4444;
                cursor: pointer;
                padding: 0.25rem;
            }

            .pending-empty {
                text-align: center;
                color: #6b7280;
                padding: 2rem;
            }

            /* Pending Panel (replaces preview + form) */
            .pending-panel {
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                padding: 1.5rem;
                width: 100%;
                min-width: 0;
            }

            .pending-panel-header {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 1rem;
            }

            .pending-panel-header h2 {
                font-size: 1.25rem;
                font-weight: 600;
            }

            .sort-toggle-btn {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.4rem 0.75rem;
                background: #f5f5f5;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 0.8rem;
                color: #666;
                cursor: pointer;
                transition: all 0.2s;
                margin-left: auto;
            }
            .sort-toggle-btn:hover {
                background: #eee;
                border-color: #ccc;
            }
            .sort-toggle-btn .sort-icon {
                font-size: 1rem;
            }

            .pending-table-container {
                overflow-y: auto;
                flex: 1;
                width: 100%;
            }

            #pendingPanel {
                display: flex;
                flex-direction: column;
                height: calc(100vh - 60px - 1rem);
                overflow: hidden;
            }

            #pendingPanel .pending-panel-header {
                flex-shrink: 0;
            }

            .pending-table-container .pending-table th {
                position: sticky;
                top: 0;
                background: #fff;
                z-index: 1;
            }

            .quotes-table-container {
                overflow-y: auto;
                flex: 1;
                width: 100%;
            }

            #quotesPanel {
                display: flex;
                flex-direction: column;
                height: calc(100vh - 60px - 1rem);
                overflow: hidden;
            }

            #quotesPanel .pending-panel-header,
            #quotesPanel .quotes-form {
                flex-shrink: 0;
            }

            #settingsPanel {
                display: flex;
                flex-direction: column;
                height: calc(100vh - 60px - 1rem);
                overflow: hidden;
            }

            #settingsPanel .pending-panel-header {
                flex-shrink: 0;
            }

            .settings-content {
                overflow-y: auto;
                flex: 1;
                padding-top: 0.5rem;
            }

            .settings-section {
                background: #f9fafb;
                border-radius: 8px;
                padding: 1.25rem;
                margin-bottom: 1rem;
            }

            .settings-section-title {
                font-size: 1rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid #e5e7eb;
            }

            .pending-table {
                width: 100%;
                border-collapse: collapse;
                overflow: visible;
            }

            .pending-table th,
            .pending-table td {
                padding: 0.75rem 1rem;
                text-align: left;
                border-bottom: 1px solid #e5e5e5;
                overflow: visible;
            }

            .pending-table td:first-child {
                overflow: visible;
                position: relative;
            }

            .pending-table th {
                font-size: 0.75rem;
                font-weight: 600;
                color: #6b7280;
                text-transform: uppercase;
                background: #f9fafb;
            }

            .quotes-table-container .pending-table th {
                position: sticky;
                top: 0;
                z-index: 1;
            }

            .quote-text-cell {
                cursor: default;
            }

            /* Used quote styling */
            .quote-row-used {
                background: rgba(16, 185, 129, 0.15) !important;
            }
            .quote-row-used td {
                border-bottom-color: rgba(16, 185, 129, 0.3) !important;
            }
            .quote-used-badge {
                display: inline-block;
                padding: 2px 6px;
                background: #10b981;
                color: white;
                border-radius: 4px;
                font-size: 0.7rem;
                margin-left: 0.5rem;
                vertical-align: middle;
            }
            .pending-table-thumb {
                width: 56px;
                height: 56px;
                border-radius: 8px;
                object-fit: cover;
                background: #e5e5e5;
                cursor: pointer;
            }

            /* Hover preview popup */
            .thumb-preview-popup {
                position: fixed;
                z-index: 9999;
                pointer-events: none;
                border-radius: 8px;
                max-width: 280px;
                max-height: 500px;
                object-fit: contain;
                display: none;
            }

            /* Pending Skeleton Loading */
            .pending-skeleton {
                padding: 1rem;
                height: 100%;
                display: flex;
                flex-direction: column;
            }

            .pending-skeleton-row {
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 0.75rem 0;
                border-bottom: 1px solid #f3f4f6;
            }

            .pending-skeleton-row .sk-img {
                width: 56px;
                height: 56px;
                border-radius: 8px;
                background: linear-gradient(
                    90deg,
                    #e5e5e5 25%,
                    #f0f0f0 50%,
                    #e5e5e5 75%
                );
                background-size: 200% 100%;
                animation: skeleton-shimmer 1.5s infinite;
            }

            .pending-skeleton-row .sk-text {
                flex: 1;
                height: 16px;
                border-radius: 4px;
                background: linear-gradient(
                    90deg,
                    #e5e5e5 25%,
                    #f0f0f0 50%,
                    #e5e5e5 75%
                );
                background-size: 200% 100%;
                animation: skeleton-shimmer 1.5s infinite;
            }

            .pending-skeleton-row .sk-date {
                width: 120px;
                height: 14px;
                border-radius: 4px;
                background: linear-gradient(
                    90deg,
                    #e5e5e5 25%,
                    #f0f0f0 50%,
                    #e5e5e5 75%
                );
                background-size: 200% 100%;
                animation: skeleton-shimmer 1.5s infinite;
            }

            .pending-skeleton-row .sk-badge {
                width: 80px;
                height: 24px;
                border-radius: 12px;
                background: linear-gradient(
                    90deg,
                    #e5e5e5 25%,
                    #f0f0f0 50%,
                    #e5e5e5 75%
                );
                background-size: 200% 100%;
                animation: skeleton-shimmer 1.5s infinite;
            }

            @keyframes skeleton-shimmer {
                0% {
                    background-position: -200% 0;
                }

                100% {
                    background-position: 200% 0;
                }
            }

            /* Image Lightbox */
            .lightbox-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.85);
                z-index: 9999;
                display: none;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            }

            .lightbox-overlay.show {
                display: flex;
            }

            .lightbox-image {
                max-width: 90vw;
                max-height: 90vh;
                border-radius: 8px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            }

            .lightbox-close {
                position: absolute;
                top: 20px;
                right: 20px;
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                font-size: 1.5rem;
                cursor: pointer;
                transition: background 0.2s;
            }

            .lightbox-close:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            .pending-table-title {
                font-weight: 500;
                font-size: 0.875rem;
            }

            .pending-table-url {
                font-size: 0.75rem;
                color: #6b7280;
                max-width: 250px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .pending-table-time {
                font-size: 0.875rem;
                color: #7c3aed;
                font-weight: 500;
            }

            .pending-table-status {
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
                border-radius: 4px;
                background: #fef3c7;
                color: #92400e;
                text-decoration: none;
                cursor: pointer;
                transition:
                    transform 0.15s,
                    box-shadow 0.15s;
            }

            .pending-table-status:hover {
                transform: scale(1.05);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .pending-table-edit {
                background: #e0e7ff;
                border: none;
                color: #4f46e5;
                padding: 0.5rem;
                border-radius: 6px;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

            .pending-table-edit:hover {
                background: #c7d2fe;
            }

            .pending-table-delete {
                background: #fee2e2;
                border: none;
                color: #ef4444;
                padding: 0.5rem;
                border-radius: 6px;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

            .pending-table-delete:hover {
                background: #fecaca;
            }

            /* Edit Time Modal */
            .edit-time-modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            }

            .edit-time-modal-content {
                background: white;
                padding: 1.5rem;
                border-radius: 12px;
                min-width: 320px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            }

            .edit-time-modal-content h3 {
                margin: 0 0 1.25rem 0;
                font-size: 1.1rem;
                color: #1f2937;
            }

            .edit-time-fields {
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .edit-time-field {
                flex: 1;
            }

            .edit-time-field label {
                display: block;
                font-size: 0.8rem;
                color: #6b7280;
                margin-bottom: 0.5rem;
            }

            .edit-time-field input {
                width: 100%;
                padding: 0.6rem 0.75rem;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                font-size: 0.95rem;
                box-sizing: border-box;
            }

            .edit-time-field input:focus {
                outline: none;
                border-color: #7c3aed;
                box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
            }

            .edit-time-actions {
                display: flex;
                gap: 0.75rem;
                justify-content: flex-end;
            }

            .edit-time-cancel {
                padding: 0.6rem 1.25rem;
                border: 1px solid #e5e7eb;
                background: white;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.9rem;
                color: #6b7280;
            }

            .edit-time-cancel:hover {
                background: #f9fafb;
            }

            .edit-time-save {
                padding: 0.6rem 1.25rem;
                border: none;
                background: #1f2937;
                color: white;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 500;
            }

            .edit-time-save:hover {
                background: #374151;
            }

            .delete-confirm-btn {
                padding: 0.6rem 1.25rem;
                border: none;
                background: #ef4444;
                color: white;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 500;
            }

            .delete-confirm-btn:hover {
                background: #dc2626;
            }

            .delete-confirm-btn:disabled {
                background: #fca5a5;
                cursor: not-allowed;
            }

            /* Post Type Badges */
            .post-type-badge {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 32px;
                height: 32px;
                border-radius: 8px;
                font-size: 1.1rem;
                cursor: default;
            }
            .post-type-link {
                background: #dbeafe;
            }
            .post-type-image {
                background: #d1fae5;
            }
            .post-type-reels {
                background: #fce7f3;
            }

            /* Token Info Popup Modal */
            .token-modal-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                justify-content: center;
                align-items: center;
            }

            .token-modal-overlay.show {
                display: flex;
            }

            .token-modal {
                background: white;
                border-radius: 12px;
                padding: 1.5rem;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            }

            .token-modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
                border-bottom: 1px solid #e5e7eb;
            }

            .token-modal-title {
                font-size: 1.25rem;
                font-weight: 600;
                color: #111827;
            }

            .token-modal-close {
                background: none;
                border: none;
                cursor: pointer;
                padding: 0.25rem;
                color: #6b7280;
            }

            .token-modal-close:hover {
                color: #111827;
            }

            .token-item {
                margin-bottom: 1rem;
            }

            .token-label {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-weight: 500;
                color: #374151;
                margin-bottom: 0.5rem;
            }

            .token-status {
                padding: 0.125rem 0.5rem;
                border-radius: 9999px;
                font-size: 0.75rem;
                font-weight: 500;
            }

            .token-status.valid {
                background: #dcfce7;
                color: #166534;
            }

            .token-status.invalid {
                background: #fee2e2;
                color: #991b1b;
            }

            .token-value {
                background: #f3f4f6;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 0.75rem;
                font-family: monospace;
                font-size: 0.75rem;
                word-break: break-all;
                color: #374151;
                max-height: 100px;
                overflow-y: auto;
            }

            .token-value.empty {
                color: #9ca3af;
                font-style: italic;
            }

            .token-copy-btn {
                margin-top: 0.5rem;
                background: #f3f4f6;
                border: 1px solid #e5e7eb;
                padding: 0.375rem 0.75rem;
                border-radius: 6px;
                font-size: 0.75rem;
                cursor: pointer;
                color: #374151;
            }

            .token-copy-btn:hover {
                background: #e5e7eb;
            }

            .status-indicator {
                cursor: pointer;
                transition: transform 0.1s;
            }

            .status-indicator:hover {
                transform: scale(1.05);
            }
        </style>
    </head>

    <body>
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"
                    />
                </svg>
                Pubilo<span>v3</span>
            </div>
            <div class="header-right">
                <div class="status-indicators" id="statusIndicators">
                    <div
                        class="status-indicator invalid"
                        id="tokenIndicator"
                        title="Token"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"
                            />
                        </svg>
                        <span>Token</span>
                    </div>
                    <div
                        class="status-indicator invalid"
                        id="cookieIndicator"
                        title="Cookie"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <circle cx="12" cy="12" r="10" />
                            <circle cx="8" cy="9" r="1.5" fill="currentColor" />
                            <circle cx="15" cy="8" r="1" fill="currentColor" />
                            <circle cx="10" cy="14" r="1" fill="currentColor" />
                            <circle
                                cx="16"
                                cy="13"
                                r="1.5"
                                fill="currentColor"
                            />
                            <circle cx="13" cy="17" r="1" fill="currentColor" />
                        </svg>
                        <span>Cookie</span>
                    </div>
                    <div
                        class="status-indicator invalid"
                        id="postTokenIndicator"
                        title="Post Token"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path d="M12 20h9" />
                            <path
                                d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                            />
                        </svg>
                        <span>Post</span>
                    </div>
                </div>
                <div class="user-avatar" id="headerUserAvatar">
                    <img
                        id="headerAvatarImg"
                        src=""
                        alt=""
                        style="
                            width: 100%;
                            height: 100%;
                            border-radius: 50%;
                            object-fit: cover;
                            display: none;
                        "
                    />
                    <span id="headerAvatarInitial">U</span>
                </div>
            </div>
        </header>

        <!-- Token Info Modal -->
        <div class="token-modal-overlay" id="tokenModal">
            <div class="token-modal">
                <div class="token-modal-header">
                    <div class="token-modal-title" id="tokenModalTitle">
                        Token
                    </div>
                    <button
                        class="token-modal-close"
                        onclick="closeTokenModal()"
                    >
                        <svg
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path d="M18 6L6 18M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="token-item" id="modalAdsItem">
                    <div class="token-label">
                        Ads Token (EAABsbCS...)
                        <span class="token-status" id="modalAdsTokenStatus"
                            >-</span
                        >
                    </div>
                    <div class="token-value" id="modalAdsTokenValue">-</div>
                    <button class="token-copy-btn" onclick="copyToken('ads')">
                        Copy
                    </button>
                </div>
                <div class="token-item" id="modalCookieItem">
                    <div class="token-label">
                        Cookie
                        <span class="token-status" id="modalCookieStatus"
                            >-</span
                        >
                    </div>
                    <div class="token-value" id="modalCookieValue">-</div>
                    <button
                        class="token-copy-btn"
                        onclick="copyToken('cookie')"
                    >
                        Copy
                    </button>
                </div>
                <div class="token-item" id="modalPostItem">
                    <div class="token-label">
                        Post Token (EAAChZC...)
                        <span class="token-status" id="modalPostTokenStatus"
                            >-</span
                        >
                    </div>
                    <div class="token-value" id="modalPostTokenValue">-</div>
                    <button class="token-copy-btn" onclick="copyToken('post')">
                        Copy
                    </button>
                </div>
            </div>
        </div>

        <!-- App Layout -->
        <div class="app-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Page Selector at top of sidebar -->
                <div class="sidebar-page-selector">
                    <div
                        class="page-selector-skeleton"
                        id="pageSelectorSkeleton"
                    >
                        <div class="sk-avatar"></div>
                        <div class="sk-lines">
                            <div class="sk-line"></div>
                            <div class="sk-line"></div>
                        </div>
                    </div>
                    <div
                        class="page-selector"
                        id="pageSelector"
                        style="display: none"
                    >
                        <img
                            class="preview-avatar-img"
                            id="previewAvatarImg"
                            src=""
                            alt=""
                        />
                        <div class="preview-page-info">
                            <h3 id="previewPageName">Select Page</h3>
                            <p id="previewPageId">-</p>
                        </div>
                        <svg
                            class="page-dropdown-icon"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path d="M6 9l6 6 6-6" />
                        </svg>
                    </div>
                    <div class="page-dropdown" id="pageDropdown"></div>
                </div>

                <nav class="sidebar-nav">
                    <div class="nav-section">
                        <div class="nav-section-title">Main</div>
                        <a
                            href="#"
                            class="nav-item active"
                            id="dashboardNavItem"
                        >
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
                                />
                                <path
                                    d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
                                />
                            </svg>
                            Link
                        </a>
                        <a href="#" class="nav-item" id="imageNavItem">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <rect
                                    x="3"
                                    y="3"
                                    width="18"
                                    height="18"
                                    rx="2"
                                    ry="2"
                                />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <polyline points="21 15 16 10 5 21" />
                            </svg>
                            Image
                        </a>
                        <a href="#" class="nav-item" id="reelsNavItem">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <rect
                                    x="2"
                                    y="2"
                                    width="20"
                                    height="20"
                                    rx="2.18"
                                    ry="2.18"
                                />
                                <line x1="7" y1="2" x2="7" y2="22" />
                                <line x1="17" y1="2" x2="17" y2="22" />
                                <line x1="2" y1="12" x2="22" y2="12" />
                                <line x1="2" y1="7" x2="7" y2="7" />
                                <line x1="2" y1="17" x2="7" y2="17" />
                                <line x1="17" y1="7" x2="22" y2="7" />
                                <line x1="17" y1="17" x2="22" y2="17" />
                            </svg>
                            Reels
                        </a>
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">Queue</div>
                        <a href="#" class="nav-item" id="pendingNavItem">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <circle cx="12" cy="12" r="10" />
                                <polyline points="12 6 12 12 16 14" />
                            </svg>
                            Pending
                            <span
                                class="badge"
                                id="pendingBadge"
                                style="display: none"
                                >0</span
                            >
                        </a>
                        </div>

                    <div class="nav-section">
                        <div class="nav-section-title">Tools</div>
                        <a href="#" class="nav-item">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <rect
                                    x="3"
                                    y="3"
                                    width="18"
                                    height="18"
                                    rx="2"
                                    ry="2"
                                />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <polyline points="21 15 16 10 5 21" />
                            </svg>
                            AI Image Gen
                        </a>
                        <a href="#quotes" class="nav-item" id="quotesNavItem">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V21z" />
                                <path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3z" />
                            </svg>
                            Quotes
                        </a>
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">SETTINGS</div>
                        <a href="#settings" class="nav-item" id="settingsNavBtn">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <circle cx="12" cy="12" r="3" />
                                <path
                                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                                />
                            </svg>
                            Settings
                        </a>
                    </div>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- ========== LINK MODE ========== -->
                <div class="mode-container active" id="linkModeContainer">
                    <!-- Preview Panel - Center -->
                    <div class="preview-panel">
                        <!-- Card Preview -->
                        <div class="card-preview">
                            <div class="card-image-area" id="cardImageArea">
                                <div class="upload-prompt" id="uploadPrompt">
                                    <div class="upload-buttons">
                                        <button
                                            class="upload-btn upload-from-device"
                                            id="uploadFromDevice"
                                        >
                                            <svg
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="2"
                                            >
                                                <path
                                                    d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                                                />
                                                <polyline
                                                    points="17 8 12 3 7 8"
                                                />
                                                <line
                                                    x1="12"
                                                    y1="3"
                                                    x2="12"
                                                    y2="15"
                                                />
                                            </svg>
                                            <span>à¸­à¸±à¸žà¹‚à¸«à¸¥à¸”à¸ˆà¸²à¸à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡</span>
                                        </button>
                                        <button
                                            class="upload-btn upload-from-gemini"
                                            id="uploadFromGemini"
                                        >
                                            <svg
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="2"
                                            >
                                                <polygon
                                                    points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                                                />
                                            </svg>
                                            <span>à¹€à¸ˆà¸™à¸ˆà¸²à¸ Gemini</span>
                                        </button>
                                    </div>
                                </div>
                                <div
                                    class="generate-overlay"
                                    id="generateOverlay"
                                    style="display: none"
                                >
                                    <button
                                        class="btn-generate"
                                        id="generateBtn"
                                    >
                                        <svg
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                        >
                                            <polygon
                                                points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                                            />
                                        </svg>
                                        Generate
                                    </button>
                                </div>
                                <div
                                    class="ref-thumbs-row"
                                    id="refThumbsRow"
                                    style="display: none"
                                ></div>
                                <div
                                    class="generated-grid"
                                    id="generatedGrid"
                                    style="display: none"
                                ></div>
                                <div
                                    class="skeleton-grid"
                                    id="skeletonGrid"
                                    style="display: none"
                                >
                                    <div class="skeleton-card"></div>
                                    <div class="skeleton-card"></div>
                                    <div class="skeleton-card"></div>
                                    <div class="skeleton-card"></div>
                                </div>
                                <div
                                    class="full-image-view"
                                    id="fullImageView"
                                    style="display: none"
                                ></div>
                            </div>
                            <div class="card-link-info" id="cardLinkInfo">
                                <div class="card-link-details">
                                    <div
                                        class="card-link-caption editable-text"
                                        id="previewCaption"
                                    >
                                        S.LAZADA.CO.TH
                                    </div>
                                    <div class="card-link-title">
                                        <span class="description-prefix">à¸žà¸´à¸à¸±à¸” : </span><span
                                            class="editable-text"
                                            id="previewDescription"
                                        ></span>
                                    </div>
                                </div>
                                <div class="card-button-wrapper">
                                    <button
                                        class="btn-learn-more"
                                        id="previewCardButton"
                                    >
                                        <span id="cardButtonText"
                                            >Shop Now</span
                                        >
                                    </button>
                                    <div
                                        class="card-button-dropdown"
                                        id="cardButtonDropdown"
                                    >
                                        <div
                                            class="card-button-option"
                                            data-value="LEARN_MORE"
                                        >
                                            Learn More
                                        </div>
                                        <div
                                            class="card-button-option selected"
                                            data-value="SHOP_NOW"
                                        >
                                            Shop Now
                                        </div>
                                        <div
                                            class="card-button-option"
                                            data-value="SIGN_UP"
                                        >
                                            Sign Up
                                        </div>
                                        <div
                                            class="card-button-option"
                                            data-value="BOOK_NOW"
                                        >
                                            Book Now
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Form -->
                    <div class="form-panel">
                        <!-- Hidden values from server config -->
                        <input type="hidden" id="pageSelect" value="" />
                        <input type="hidden" id="adAccountSelect" value="" />

                        <div class="card">
                            <div
                                style="
                                    display: flex;
                                    justify-content: flex-start;
                                    align-items: center;
                                    margin-bottom: 1rem;
                                "
                            >
                                <button class="btn-publish" id="publishBtn">
                                    PUBLISH
                                </button>
                            </div>
                            <!-- Link-only fields (hidden in Image mode) -->
                            <div id="linkOnlyFields">
                                <div class="form-group">
                                    <label class="form-label">Link URL</label>
                                    <input
                                        type="text"
                                        class="form-input"
                                        id="linkUrl"
                                        placeholder=""
                                    />
                                    <small
                                        id="lazadaStatus"
                                        style="
                                            color: #888;
                                            margin-top: 4px;
                                            display: block;
                                        "
                                    ></small>
                                </div>
                                <!-- Hidden inputs for Link Name, Caption, Description (editable via double-click in preview) -->
                                <input
                                    type="hidden"
                                    id="linkName"
                                    value="S.LAZADA.CO.TH"
                                />
                                <input
                                    type="hidden"
                                    id="caption"
                                    value="S.LAZADA.CO.TH"
                                />
                                <input
                                    type="hidden"
                                    id="description"
                                    value=""
                                />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Primary Text</label>
                                <textarea
                                    class="form-textarea"
                                    id="primaryText"
                                    placeholder="Write something about your post..."
                                ></textarea>
                            </div>
                            <!-- Card Button - now controlled from preview -->
                            <div
                                id="cardButtonGroup"
                                class="form-group"
                                style="display: none"
                            >
                                <select class="form-select" id="cardButton">
                                    <option value="LEARN_MORE">
                                        Learn More
                                    </option>
                                    <option value="SHOP_NOW" selected>Shop Now</option>
                                    <option value="SIGN_UP">Sign Up</option>
                                    <option value="BOOK_NOW">Book Now</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End linkModeContainer -->

                <!-- ========== IMAGE MODE ========== -->
                <div class="mode-container" id="imageModeContainer">
                    <!-- Preview Panel -->
                    <div class="preview-panel">
                        <div class="card-preview">
                            <div
                                class="card-image-area"
                                id="imageCardImageArea"
                            >
                                <div
                                    class="upload-prompt"
                                    id="imageUploadPrompt"
                                >
                                    <div class="upload-buttons">
                                        <button
                                            class="upload-btn upload-from-device"
                                            id="imageUploadFromDevice"
                                        >
                                            <svg
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="2"
                                            >
                                                <path
                                                    d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                                                />
                                                <polyline
                                                    points="17 8 12 3 7 8"
                                                />
                                                <line
                                                    x1="12"
                                                    y1="3"
                                                    x2="12"
                                                    y2="15"
                                                />
                                            </svg>
                                            <span>à¸­à¸±à¸žà¹‚à¸«à¸¥à¸”à¸ˆà¸²à¸à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡</span>
                                        </button>
                                        <button
                                            class="upload-btn upload-from-gemini"
                                            id="imageUploadFromGemini"
                                        >
                                            <svg
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="2"
                                            >
                                                <polygon
                                                    points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                                                />
                                            </svg>
                                            <span>à¹€à¸ˆà¸™à¸ˆà¸²à¸ Gemini</span>
                                        </button>
                                    </div>
                                </div>
                                <div
                                    class="generate-overlay"
                                    id="imageGenerateOverlay"
                                    style="display: none"
                                >
                                    <button
                                        class="btn-generate"
                                        id="imageGenerateBtn"
                                    >
                                        <svg
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                        >
                                            <polygon
                                                points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                                            />
                                        </svg>
                                        Generate
                                    </button>
                                </div>
                                <div
                                    class="ref-thumbs-row"
                                    id="imageRefThumbsRow"
                                    style="display: none"
                                ></div>
                                <div
                                    class="generated-grid"
                                    id="imageGeneratedGrid"
                                    style="display: none"
                                ></div>
                                <div
                                    class="skeleton-grid"
                                    id="imageSkeletonGrid"
                                    style="display: none"
                                >
                                    <div class="skeleton-card"></div>
                                    <div class="skeleton-card"></div>
                                    <div class="skeleton-card"></div>
                                    <div class="skeleton-card"></div>
                                </div>
                                <div
                                    class="full-image-view"
                                    id="imageFullImageView"
                                    style="display: none"
                                ></div>
                            </div>
                        </div>
                    </div>
                    <!-- Form Panel -->
                    <div class="form-panel">
                        <div class="card">
                            <div
                                style="
                                    display: flex;
                                    justify-content: flex-start;
                                    align-items: center;
                                    margin-bottom: 1rem;
                                "
                            >
                                <button
                                    class="btn-publish"
                                    id="imagePublishBtn"
                                >
                                    PUBLISH
                                </button>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Primary Text</label>
                                <textarea
                                    class="form-textarea"
                                    id="imagePrimaryText"
                                    placeholder="Write something about your post..."
                                ></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End imageModeContainer -->

                <!-- ========== REELS MODE ========== -->
                <div class="mode-container" id="reelsModeContainer">
                    <!-- Preview Panel -->
                    <div class="preview-panel">
                        <div class="card-preview">
                            <div
                                class="card-image-area"
                                id="reelsCardImageArea"
                            >
                                <div
                                    class="upload-prompt"
                                    id="reelsUploadPrompt"
                                >
                                    <div class="upload-buttons">
                                        <button
                                            class="upload-btn upload-from-device"
                                            id="reelsUploadFromDevice"
                                        >
                                            <svg
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="2"
                                            >
                                                <path
                                                    d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                                                />
                                                <polyline
                                                    points="17 8 12 3 7 8"
                                                />
                                                <line
                                                    x1="12"
                                                    y1="3"
                                                    x2="12"
                                                    y2="15"
                                                />
                                            </svg>
                                            <span>à¸­à¸±à¸žà¹‚à¸«à¸¥à¸”à¸ˆà¸²à¸à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡</span>
                                        </button>
                                        <button
                                            class="upload-btn upload-from-gemini"
                                            id="reelsUploadFromGemini"
                                        >
                                            <svg
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="2"
                                            >
                                                <polygon
                                                    points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                                                />
                                            </svg>
                                            <span>à¹€à¸ˆà¸™à¸ˆà¸²à¸ Gemini</span>
                                        </button>
                                    </div>
                                </div>
                                <div
                                    class="generate-overlay"
                                    id="reelsGenerateOverlay"
                                    style="display: none"
                                >
                                    <button
                                        class="btn-generate"
                                        id="reelsGenerateBtn"
                                    >
                                        <svg
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                        >
                                            <polygon
                                                points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                                            />
                                        </svg>
                                        Generate
                                    </button>
                                </div>
                                <div
                                    class="ref-thumbs-row"
                                    id="reelsRefThumbsRow"
                                    style="display: none"
                                ></div>
                                <div
                                    class="generated-grid"
                                    id="reelsGeneratedGrid"
                                    style="display: none"
                                ></div>
                                <div
                                    class="skeleton-grid"
                                    id="reelsSkeletonGrid"
                                    style="display: none"
                                >
                                    <div class="skeleton-card"></div>
                                    <div class="skeleton-card"></div>
                                    <div class="skeleton-card"></div>
                                    <div class="skeleton-card"></div>
                                </div>
                                <div
                                    class="full-image-view"
                                    id="reelsFullImageView"
                                    style="display: none"
                                ></div>
                            </div>
                        </div>
                    </div>
                    <!-- Form Panel -->
                    <div class="form-panel">
                        <div class="card">
                            <div
                                style="
                                    display: flex;
                                    justify-content: flex-start;
                                    align-items: center;
                                    margin-bottom: 1rem;
                                "
                            >
                                <button
                                    class="btn-publish"
                                    id="reelsPublishBtn"
                                >
                                    PUBLISH
                                </button>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Primary Text</label>
                                <textarea
                                    class="form-textarea"
                                    id="reelsPrimaryText"
                                    placeholder="Write something about your post..."
                                ></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End reelsModeContainer -->

                <!-- Pending Panel (replaces preview + form) -->
                <div
                    class="pending-panel"
                    id="pendingPanel"
                    style="display: none"
                >
                    <div class="pending-panel-header">
                        <h2>Pending Posts</h2>
                        <button class="sort-toggle-btn" id="sortToggleBtn">
                            <span class="sort-icon">â†“</span>
                            <span class="sort-label">à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸à¹ˆà¸­à¸™</span>
                        </button>
                    </div>
                    <div
                        class="pending-table-container"
                        id="pendingTableContainer"
                    >
                        <div class="pending-empty">No pending posts</div>
                    </div>
                </div>

                <!-- Quotes Panel -->
                <div
                    class="pending-panel"
                    id="quotesPanel"
                    style="display: none"
                >
                    <div class="pending-panel-header">
                        <h2>Quotes</h2>
                    </div>
                    <div class="quotes-form" style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
                        <input
                            type="text"
                            id="quoteInput"
                            placeholder="à¹€à¸žà¸´à¹ˆà¸¡à¸„à¸³à¸„à¸¡à¹ƒà¸«à¸¡à¹ˆ..."
                            style="flex: 1; padding: 0.75rem 1rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;"
                        />
                        <button
                            id="addQuoteBtn"
                            style="padding: 0.75rem 1.5rem; background: #1877f2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;"
                        >
                            à¹€à¸žà¸´à¹ˆà¸¡
                        </button>
                    </div>
                    <div
                        class="quotes-table-container"
                        id="quotesTableContainer"
                    >
                        <div class="pending-empty">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸³à¸„à¸¡</div>
                    </div>
                </div>

                <!-- Settings Panel -->
                <div
                    class="pending-panel"
                    id="settingsPanel"
                    style="display: none"
                >
                    <div class="pending-panel-header">
                        <h2>Settings</h2>
                    </div>
                    <div class="settings-content">
                        <!-- Schedule Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title">à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¹‚à¸žà¸ªà¸•à¹Œ</h3>
                            <div class="setting-group">
                                <label class="setting-label">
                                    <input type="checkbox" id="autoScheduleEnabledPanel" />
                                    <span>Auto Schedule Posts</span>
                                </label>
                                <p class="setting-desc">
                                    à¹‚à¸žà¸ªà¸•à¹Œà¸ˆà¸°à¸–à¸¹à¸à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸•à¸²à¸¡à¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”
                                </p>
                            </div>
                            <div
                                class="setting-group"
                                id="scheduleIntervalGroupPanel"
                                style="display: none"
                            >
                                <label class="form-label">à¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹‚à¸žà¸ªà¸•à¹Œ</label>
                                <input
                                    type="text"
                                    class="form-input"
                                    id="scheduleMinutesPanel"
                                    value="00, 15, 30, 45"
                                    placeholder="00, 15, 30, 45"
                                />
                                <p class="setting-desc">
                                    à¹ƒà¸ªà¹ˆà¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹‚à¸žà¸ªà¸•à¹Œ à¸„à¸±à¹ˆà¸™à¸”à¹‰à¸§à¸¢à¸„à¸­à¸¡à¸¡à¹ˆà¸² à¹€à¸Šà¹ˆà¸™ 00, 15, 30, 45 = à¹‚à¸žà¸ªà¸•à¹Œà¸—à¸¸à¸ 15 à¸™à¸²à¸—à¸µ
                                </p>
                            </div>
                            <div
                                class="setting-group"
                                id="nextScheduleInfoPanel"
                                style="display: none"
                            >
                                <label class="form-label">Next Scheduled Time</label>
                                <div
                                    class="next-schedule-display"
                                    id="nextScheduleDisplayPanel"
                                >
                                    -
                                </div>
                            </div>
                        </div>

                        <!-- Link Post AI Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title">ðŸ”— Link Post - AI Image</h3>
                            <div class="setting-group">
                                <label class="form-label">Prompt à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸ˆà¸™à¸£à¸¹à¸› Link Post</label>
                                <textarea
                                    id="linkPromptInput"
                                    class="form-input"
                                    rows="3"
                                    placeholder="à¹ƒà¸ªà¹ˆ prompt à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸ˆà¸™à¸£à¸¹à¸› Link Post à¹€à¸Šà¹ˆà¸™: A professional banner image..."
                                    style="resize: vertical; min-height: 80px;"
                                ></textarea>
                            </div>
                            <div class="setting-group" style="margin-top: 0.75rem;">
                                <label class="form-label">à¸‚à¸™à¸²à¸”à¸£à¸¹à¸›</label>
                                <div class="radio-group" id="linkImageSizeGroup">
                                    <label class="radio-option"><input type="radio" name="linkImageSize" value="1:1" checked> 1:1</label>
                                    <label class="radio-option"><input type="radio" name="linkImageSize" value="16:9"> 16:9</label>
                                    <label class="radio-option"><input type="radio" name="linkImageSize" value="4:3"> 4:3</label>
                                    <label class="radio-option"><input type="radio" name="linkImageSize" value="9:16"> 9:16</label>
                                    <label class="radio-option"><input type="radio" name="linkImageSize" value="2:3"> 2:3</label>
                                    <label class="radio-option"><input type="radio" name="linkImageSize" value="3:4"> 3:4</label>
                                </div>
                            </div>
                        </div>

                        <!-- Image Post AI Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title">ðŸ–¼ï¸ Image Post - AI Image</h3>
                            <div class="setting-group">
                                <label class="form-label">Prompt à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸ˆà¸™à¸£à¸¹à¸› Image Post</label>
                                <textarea
                                    id="imagePromptInput"
                                    class="form-input"
                                    rows="3"
                                    placeholder="à¹ƒà¸ªà¹ˆ prompt à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸ˆà¸™à¸£à¸¹à¸› Image Post à¹€à¸Šà¹ˆà¸™: A vibrant social media image..."
                                    style="resize: vertical; min-height: 80px;"
                                ></textarea>
                            </div>
                            <div class="setting-group" style="margin-top: 0.75rem;">
                                <label class="form-label">à¸‚à¸™à¸²à¸”à¸£à¸¹à¸›</label>
                                <div class="radio-group" id="imageImageSizeGroup">
                                    <label class="radio-option"><input type="radio" name="imageImageSize" value="1:1" checked> 1:1</label>
                                    <label class="radio-option"><input type="radio" name="imageImageSize" value="16:9"> 16:9</label>
                                    <label class="radio-option"><input type="radio" name="imageImageSize" value="4:3"> 4:3</label>
                                    <label class="radio-option"><input type="radio" name="imageImageSize" value="9:16"> 9:16</label>
                                    <label class="radio-option"><input type="radio" name="imageImageSize" value="2:3"> 2:3</label>
                                    <label class="radio-option"><input type="radio" name="imageImageSize" value="3:4"> 3:4</label>
                                </div>
                            </div>
                        </div>

                        <!-- AI Model Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title">ðŸ¤– AI Image Generation</h3>
                            <div class="setting-group">
                                <label class="form-label">à¹‚à¸¡à¹€à¸”à¸¥</label>
                                <select id="aiModelSelect" class="form-input" style="padding: 0.5rem;">
                                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental)</option>
                                    <option value="gemini-2.0-flash-preview-image-generation">Gemini 2.0 Flash Preview</option>
                                    <option value="gemini-3-pro-image-preview">Gemini 3 Pro Image Preview (New)</option>
                                    <option value="imagen-3.0-generate-002">Imagen 3</option>
                                </select>
                            </div>
                            <div class="setting-group" style="margin-top: 1rem;">
                                <label class="form-label">à¸„à¸§à¸²à¸¡à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”</label>
                                <select id="aiResolutionSelect" class="form-input" style="padding: 0.5rem;">
                                    <option value="1K">1K (1024px)</option>
                                    <option value="2K" selected>2K (2048px)</option>
                                    <option value="4K">4K (4096px)</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn-save" id="saveSettingsPanelBtn" style="margin-top: 1rem;">
                            à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <input
            type="file"
            id="fileInput"
            multiple
            accept="image/*"
            style="display: none"
        />

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settingsModal" style="display: none">
            <div class="modal">
                <div class="modal-header">
                    <h3>Settings</h3>
                    <button class="modal-close" id="closeSettingsBtn">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="setting-group">
                        <label class="setting-label">
                            <input type="checkbox" id="autoScheduleEnabled" />
                            <span>Auto Schedule Posts</span>
                        </label>
                        <p class="setting-desc">
                            à¹‚à¸žà¸ªà¸•à¹Œà¸ˆà¸°à¸–à¸¹à¸à¸•à¸±à¹‰à¸‡à¹€à¸§à¸¥à¸²à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸•à¸²à¸¡à¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”
                        </p>
                    </div>
                    <div
                        class="setting-group"
                        id="scheduleIntervalGroup"
                        style="display: none"
                    >
                        <label class="form-label">à¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹‚à¸žà¸ªà¸•à¹Œ</label>
                        <input
                            type="text"
                            class="form-input"
                            id="scheduleMinutes"
                            value="00, 15, 30, 45"
                            placeholder="00, 15, 30, 45"
                        />
                        <p class="setting-desc">
                            à¹ƒà¸ªà¹ˆà¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹‚à¸žà¸ªà¸•à¹Œ à¸„à¸±à¹ˆà¸™à¸”à¹‰à¸§à¸¢à¸„à¸­à¸¡à¸¡à¹ˆà¸² à¹€à¸Šà¹ˆà¸™ 00, 15, 30, 45 = à¹‚à¸žà¸ªà¸•à¹Œà¸—à¸¸à¸ 15 à¸™à¸²à¸—à¸µ
                        </p>
                    </div>
                    <div
                        class="setting-group"
                        id="nextScheduleInfo"
                        style="display: none"
                    >
                        <label class="form-label">Next Scheduled Time</label>
                        <div
                            class="next-schedule-display"
                            id="nextScheduleDisplay"
                        >
                            -
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-save" id="saveSettingsBtn">
                        Save Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Hover Preview Popup (must be before script) -->
        <img class="thumb-preview-popup" id="thumbPreviewPopup" src="" alt="" />

        <script>
            // Thumb hover preview functions (must be at top)
            const thumbPreviewPopup = document.getElementById("thumbPreviewPopup");
            window.showThumbPreview = function (src, e) {
                thumbPreviewPopup.src = src;
                thumbPreviewPopup.style.display = "block";
                window.moveThumbPreview(e);
            };
            window.moveThumbPreview = function (e) {
                const x = e.clientX + 20;
                const y = e.clientY - 100;
                thumbPreviewPopup.style.left = x + "px";
                thumbPreviewPopup.style.top = Math.max(10, y) + "px";
            };
            window.hideThumbPreview = function () {
                thumbPreviewPopup.style.display = "none";
            };

            // Elements
            const fileInput = document.getElementById("fileInput");
            const cardImageArea = document.getElementById("cardImageArea");
            const uploadPrompt = document.getElementById("uploadPrompt");
            const generateOverlay = document.getElementById("generateOverlay");
            const generateBtn = document.getElementById("generateBtn");
            const refThumbsRow = document.getElementById("refThumbsRow");
            const generatedGrid = document.getElementById("generatedGrid");
            const fullImageView = document.getElementById("fullImageView");
            const publishBtn = document.getElementById("publishBtn");

            // Form elements
            const linkName = document.getElementById("linkName");
            const caption = document.getElementById("caption");
            const description = document.getElementById("description");
            const linkUrl = document.getElementById("linkUrl");

            // Validate Link URL - disable SCHEDULE button if empty in link mode
            function validateLinkMode() {
                const currentMode = document.querySelector('.nav-item.active')?.dataset?.mode || 'link';
                if (currentMode === 'link') {
                    const hasUrl = linkUrl && linkUrl.value.trim().length > 0;
                    publishBtn.disabled = !hasUrl;
                    publishBtn.style.opacity = hasUrl ? '1' : '0.5';
                    publishBtn.style.cursor = hasUrl ? 'pointer' : 'not-allowed';
                } else {
                    // Other modes don't require link URL
                    publishBtn.disabled = false;
                    publishBtn.style.opacity = '1';
                    publishBtn.style.cursor = 'pointer';
                }
            }

            // Listen for link URL changes
            if (linkUrl) {
                linkUrl.addEventListener("input", validateLinkMode);
            }

            // Initial validation
            setTimeout(validateLinkMode, 500);

            // Settings elements
            const settingsModal = document.getElementById("settingsModal");
            // Settings nav button (renamed from openSettingsBtn)
            const settingsNavBtn = document.getElementById("settingsNavBtn");
            const closeSettingsBtn =
                document.getElementById("closeSettingsBtn");
            const saveSettingsBtn = document.getElementById("saveSettingsBtn");
            const autoScheduleEnabled = document.getElementById(
                "autoScheduleEnabled",
            );
            const scheduleMinutes =
                document.getElementById("scheduleMinutes");
            const scheduleIntervalGroup = document.getElementById(
                "scheduleIntervalGroup",
            );
            const nextScheduleInfo =
                document.getElementById("nextScheduleInfo");
            const nextScheduleDisplay = document.getElementById(
                "nextScheduleDisplay",
            );

            // Cache for scheduled posts times (will be fetched from Facebook)
            let scheduledPostTimes = [];

            // Get current selected page ID
            function getCurrentPageId() {
                const pageSelect = document.getElementById("pageSelect");
                return pageSelect ? pageSelect.value : null;
            }

            // Get current aspect ratio based on mode (link or image)
            function getCurrentAspectRatio() {
                const pageId = getCurrentPageId();
                if (!pageId) return "1:1";

                // Check current mode and get from localStorage
                const isLinkMode = postMode === "link";
                const storageKey = isLinkMode ? `linkImageSize_${pageId}` : `imageImageSize_${pageId}`;
                return localStorage.getItem(storageKey) || "1:1";
            }

            // Get current prompt based on mode (link or image)
            function getCurrentPrompt() {
                const pageId = getCurrentPageId();
                if (!pageId) return "";

                // Check current mode
                const isLinkMode = postMode === "link";
                const storageKey = isLinkMode ? `linkPrompt_${pageId}` : `imagePrompt_${pageId}`;
                return localStorage.getItem(storageKey) || "";
            }

            // Cache for current page settings
            let cachedPageSettings = {
                pageId: null,
                autoSchedule: false,
                scheduleMinutes: "00, 15, 30, 45"
            };

            // Cache for scheduled posts per page
            const scheduledPostsCache = new Map(); // pageId -> { posts: [], timestamp: Date }
            const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

            function getCachedPosts(pageId) {
                const cached = scheduledPostsCache.get(pageId);
                if (!cached) return null;
                // Check if cache is still valid (within TTL)
                if (Date.now() - cached.timestamp > CACHE_TTL) {
                    scheduledPostsCache.delete(pageId);
                    return null;
                }
                return cached.posts;
            }

            function setCachedPosts(pageId, posts) {
                scheduledPostsCache.set(pageId, {
                    posts: posts,
                    timestamp: Date.now()
                });
            }

            function invalidatePostsCache(pageId = null) {
                if (pageId) {
                    scheduledPostsCache.delete(pageId);
                } else {
                    scheduledPostsCache.clear();
                }
                console.log("[FEWFEED] Cache invalidated:", pageId || "all");
            }

            // Compress image to reduce upload size (max 1200px, JPEG quality 0.8)
            function compressImage(dataUrl, maxSize = 1200, quality = 0.8) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        let w = img.width;
                        let h = img.height;
                        // Scale down if larger than maxSize
                        if (w > maxSize || h > maxSize) {
                            if (w > h) {
                                h = Math.round(h * maxSize / w);
                                w = maxSize;
                            } else {
                                w = Math.round(w * maxSize / h);
                                h = maxSize;
                            }
                        }
                        const canvas = document.createElement("canvas");
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0, w, h);
                        // Use JPEG for better compression
                        const compressed = canvas.toDataURL("image/jpeg", quality);
                        console.log("[FEWFEED] Compressed:", Math.round(dataUrl.length / 1024), "KB â†’", Math.round(compressed.length / 1024), "KB");
                        resolve(compressed);
                    };
                    img.onerror = () => resolve(dataUrl);
                    img.src = dataUrl;
                });
            }

            // Load settings from API (per-page) - database only
            async function loadSettings() {
                const pageId = getCurrentPageId();
                if (!pageId) {
                    autoScheduleEnabled.checked = false;
                    scheduleMinutes.value = "00, 15, 30, 45";
                    scheduleIntervalGroup.style.display = "none";
                    nextScheduleInfo.style.display = "none";
                    return;
                }

                try {
                    const response = await fetch(`/api/page-settings?pageId=${pageId}`);
                    const data = await response.json();

                    if (data.success && data.settings) {
                        const enabled = data.settings.auto_schedule === true;
                        const mins = data.settings.schedule_minutes || "00, 15, 30, 45";

                        // Update cache
                        cachedPageSettings = {
                            pageId,
                            autoSchedule: enabled,
                            scheduleMinutes: mins
                        };

                        autoScheduleEnabled.checked = enabled;
                        scheduleMinutes.value = mins;
                        scheduleIntervalGroup.style.display = enabled ? "block" : "none";
                        nextScheduleInfo.style.display = enabled ? "block" : "none";
                    }
                } catch (error) {
                    console.error("[FEWFEED] Failed to load settings from API:", error);
                    // Use defaults if API fails
                    cachedPageSettings = {
                        pageId,
                        autoSchedule: false,
                        scheduleMinutes: "00, 15, 30, 45"
                    };
                    autoScheduleEnabled.checked = false;
                    scheduleMinutes.value = "00, 15, 30, 45";
                    scheduleIntervalGroup.style.display = "none";
                    nextScheduleInfo.style.display = "none";
                }

                updateNextScheduleDisplay();
                updatePublishButton();
            }

            // Update publish button text
            function updatePublishButton() {
                if (!publishBtn.classList.contains("published")) {
                    publishBtn.textContent = "SCHEDULE";
                }
            }

            // Parse schedule minutes from string (e.g., "05, 10, 15" => [5, 10, 15])
            function getScheduleMinutesArray() {
                const str = scheduleMinutes.value || "00, 15, 30, 45";
                return str.split(",")
                    .map(s => parseInt(s.trim()))
                    .filter(n => !isNaN(n) && n >= 0 && n < 60)
                    .sort((a, b) => a - b);
            }

            // Fetch scheduled posts times from Facebook
            async function refreshScheduledPostTimes() {
                try {
                    const posts = await fetchScheduledPostsFromFacebook();
                    if (Array.isArray(posts)) {
                        scheduledPostTimes = posts
                            .filter(p => p.scheduledTime)
                            .map(p => new Date(p.scheduledTime * 1000));
                        console.log("[FEWFEED] Loaded scheduled times:", scheduledPostTimes.length);
                    }
                } catch (err) {
                    console.error("[FEWFEED] Failed to load scheduled times:", err);
                }
            }

            // Check if a time slot is already taken
            function isSlotTaken(slotTime) {
                const slotMinutes = slotTime.getMinutes();
                const slotHour = slotTime.getHours();
                const slotDate = slotTime.toDateString();

                return scheduledPostTimes.some(t => {
                    return t.toDateString() === slotDate &&
                           t.getHours() === slotHour &&
                           t.getMinutes() === slotMinutes;
                });
            }

            // Calculate next schedule time based on specific minutes (auto finds next free slot)
            function getNextScheduleTime() {
                const minutesArr = getScheduleMinutesArray();
                if (minutesArr.length === 0) {
                    return new Date(Date.now() + 15 * 60 * 1000);
                }

                // Facebook requires at least 10 min in the future
                const minTime = new Date(Date.now() + 10 * 60 * 1000);

                // Find first available slot
                let candidate = findNextSlot(minTime, minutesArr);

                // Keep looking until we find a free slot (max 100 iterations to prevent infinite loop)
                let iterations = 0;
                while (isSlotTaken(candidate) && iterations < 100) {
                    // Move to next slot
                    candidate = findNextSlot(new Date(candidate.getTime() + 60 * 1000), minutesArr);
                    iterations++;
                }

                return candidate;
            }

            // Find the next slot from given time based on specific minutes
            function findNextSlot(fromTime, minutesArr) {
                const result = new Date(fromTime);
                result.setSeconds(0, 0);

                const currentMinute = result.getMinutes();

                // Find next minute in array that is > currentMinute
                let foundMinute = minutesArr.find(m => m > currentMinute);

                if (foundMinute !== undefined) {
                    result.setMinutes(foundMinute, 0, 0);
                } else {
                    // Move to next hour
                    result.setHours(result.getHours() + 1);
                    result.setMinutes(minutesArr[0], 0, 0);
                }

                return result;
            }

            // Update next schedule display
            async function updateNextScheduleDisplay() {
                if (autoScheduleEnabled.checked) {
                    // Refresh scheduled times from Facebook first
                    await refreshScheduledPostTimes();
                    const nextTime = getNextScheduleTime();
                    nextScheduleDisplay.textContent =
                        nextTime.toLocaleString("th-TH");
                } else {
                    nextScheduleDisplay.textContent = "-";
                }
            }

            // Calculate next schedule for panel (uses panel's input value)
            function calculateNextScheduleForPanel() {
                const str = scheduleMinutesPanel.value || "00, 15, 30, 45";
                const minutesArr = str.split(",")
                    .map(s => parseInt(s.trim()))
                    .filter(n => !isNaN(n) && n >= 0 && n < 60)
                    .sort((a, b) => a - b);

                if (minutesArr.length === 0) {
                    return new Date(Date.now() + 15 * 60 * 1000).toLocaleString("th-TH");
                }

                const minTime = new Date(Date.now() + 10 * 60 * 1000);
                const result = new Date(minTime);
                result.setSeconds(0, 0);

                const currentMinute = result.getMinutes();
                const nextMinute = minutesArr.find(m => m > currentMinute);

                if (nextMinute !== undefined) {
                    result.setMinutes(nextMinute, 0, 0);
                } else {
                    result.setHours(result.getHours() + 1);
                    result.setMinutes(minutesArr[0], 0, 0);
                }

                return result.toLocaleString("th-TH");
            }

            // Settings modal is now deprecated - using settings panel instead
            // The settingsNavBtn click is handled in the navigation section below

            closeSettingsBtn.addEventListener("click", () => {
                settingsModal.style.display = "none";
            });


            autoScheduleEnabled.addEventListener("change", () => {
                scheduleIntervalGroup.style.display =
                    autoScheduleEnabled.checked ? "block" : "none";
                nextScheduleInfo.style.display = autoScheduleEnabled.checked
                    ? "block"
                    : "none";
                updateNextScheduleDisplay();
            });

            scheduleMinutes.addEventListener(
                "input",
                updateNextScheduleDisplay,
            );

            saveSettingsBtn.addEventListener("click", async () => {
                const pageId = getCurrentPageId();
                if (pageId) {
                    const autoSchedule = autoScheduleEnabled.checked;
                    const mins = scheduleMinutes.value || "00, 15, 30, 45";

                    // Update cache immediately
                    cachedPageSettings = {
                        pageId,
                        autoSchedule,
                        scheduleMinutes: mins
                    };

                    // Save to database via API
                    try {
                        const response = await fetch('/api/page-settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                pageId,
                                autoSchedule,
                                scheduleMinutes: mins
                            })
                        });
                        const data = await response.json();
                        if (data.success) {
                            console.log("[FEWFEED] Settings saved to database");
                        } else {
                            console.error("[FEWFEED] Failed to save settings:", data.error);
                            alert("à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: " + data.error);
                        }
                    } catch (error) {
                        console.error("[FEWFEED] API error:", error);
                        alert("à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ");
                    }
                }
                settingsModal.style.display = "none";
                updatePublishButton();
            });

            // Settings Panel functionality
            const autoScheduleEnabledPanel = document.getElementById("autoScheduleEnabledPanel");
            const scheduleMinutesPanel = document.getElementById("scheduleMinutesPanel");
            const scheduleIntervalGroupPanel = document.getElementById("scheduleIntervalGroupPanel");
            const nextScheduleInfoPanel = document.getElementById("nextScheduleInfoPanel");
            const nextScheduleDisplayPanel = document.getElementById("nextScheduleDisplayPanel");
            const linkPromptInput = document.getElementById("linkPromptInput");
            const imagePromptInput = document.getElementById("imagePromptInput");
            const aiModelSelect = document.getElementById("aiModelSelect");
            const aiResolutionSelect = document.getElementById("aiResolutionSelect");
            const saveSettingsPanelBtn = document.getElementById("saveSettingsPanelBtn");

            // Helper functions for radio buttons
            function getLinkImageSize() {
                const checked = document.querySelector('input[name="linkImageSize"]:checked');
                return checked ? checked.value : "1:1";
            }
            function setLinkImageSize(value) {
                const radio = document.querySelector(`input[name="linkImageSize"][value="${value}"]`);
                if (radio) radio.checked = true;
            }
            function getImageImageSize() {
                const checked = document.querySelector('input[name="imageImageSize"]:checked');
                return checked ? checked.value : "1:1";
            }
            function setImageImageSize(value) {
                const radio = document.querySelector(`input[name="imageImageSize"][value="${value}"]`);
                if (radio) radio.checked = true;
            }

            // Load settings into the panel
            async function loadSettingsPanel() {
                const pageId = getCurrentPageId();
                if (!pageId) {
                    console.log("[Settings Panel] No page selected");
                    return;
                }

                // Try to load from cache first, otherwise fetch from API
                let settings = null;
                if (cachedPageSettings && cachedPageSettings.pageId === pageId) {
                    settings = cachedPageSettings;
                } else {
                    // Fetch from API
                    try {
                        const response = await fetch(`/api/page-settings?pageId=${pageId}`);
                        const data = await response.json();
                        if (data.success && data.settings) {
                            settings = {
                                pageId,
                                autoSchedule: data.settings.auto_schedule,
                                scheduleMinutes: data.settings.schedule_minutes
                            };
                            // Update cache
                            cachedPageSettings = settings;
                            console.log("[Settings Panel] Loaded from API:", settings);
                        }
                    } catch (err) {
                        console.error("[Settings Panel] Failed to load settings:", err);
                    }
                }

                // Apply settings to panel
                if (settings) {
                    autoScheduleEnabledPanel.checked = settings.autoSchedule || false;
                    scheduleMinutesPanel.value = settings.scheduleMinutes || "00, 15, 30, 45";
                } else {
                    autoScheduleEnabledPanel.checked = false;
                    scheduleMinutesPanel.value = "00, 15, 30, 45";
                }

                // Update visibility
                scheduleIntervalGroupPanel.style.display = autoScheduleEnabledPanel.checked ? "block" : "none";
                nextScheduleInfoPanel.style.display = autoScheduleEnabledPanel.checked ? "block" : "none";
                if (autoScheduleEnabledPanel.checked) {
                    nextScheduleDisplayPanel.textContent = calculateNextScheduleForPanel();
                }

                // Load AI prompts from database (with localStorage fallback)
                try {
                    const promptsRes = await fetch(`/api/prompts?pageId=${pageId}`);
                    const promptsData = await promptsRes.json();
                    if (promptsData.success && promptsData.prompts.length > 0) {
                        const linkPrompt = promptsData.prompts.find(p => p.prompt_type === 'link_post');
                        const imagePrompt = promptsData.prompts.find(p => p.prompt_type === 'image_post');
                        linkPromptInput.value = linkPrompt?.prompt_text || "";
                        imagePromptInput.value = imagePrompt?.prompt_text || "";
                    } else {
                        // Try loading default prompts
                        const defaultRes = await fetch(`/api/prompts?pageId=_default`);
                        const defaultData = await defaultRes.json();
                        if (defaultData.success && defaultData.prompts.length > 0) {
                            const defaultLinkPrompt = defaultData.prompts.find(p => p.prompt_type === 'link_post');
                            const defaultImagePrompt = defaultData.prompts.find(p => p.prompt_type === 'image_post');
                            linkPromptInput.value = defaultLinkPrompt?.prompt_text || localStorage.getItem(`linkPrompt_${pageId}`) || "";
                            imagePromptInput.value = defaultImagePrompt?.prompt_text || localStorage.getItem(`imagePrompt_${pageId}`) || "";
                        } else {
                            // Fallback to localStorage
                            linkPromptInput.value = localStorage.getItem(`linkPrompt_${pageId}`) || "";
                            imagePromptInput.value = localStorage.getItem(`imagePrompt_${pageId}`) || "";
                        }
                    }
                } catch (e) {
                    console.error('[Settings] Failed to load prompts from DB:', e);
                    linkPromptInput.value = localStorage.getItem(`linkPrompt_${pageId}`) || "";
                    imagePromptInput.value = localStorage.getItem(`imagePrompt_${pageId}`) || "";
                }

                // Load image sizes from localStorage (per page)
                const savedLinkImageSize = localStorage.getItem(`linkImageSize_${pageId}`) || "1:1";
                const savedImageImageSize = localStorage.getItem(`imageImageSize_${pageId}`) || "1:1";
                setLinkImageSize(savedLinkImageSize);
                setImageImageSize(savedImageImageSize);

                // Load AI settings (global, not per page)
                const savedAiModel = localStorage.getItem("aiModel") || "gemini-2.0-flash-exp";
                const savedAiResolution = localStorage.getItem("aiResolution") || "2K";
                aiModelSelect.value = savedAiModel;
                aiResolutionSelect.value = savedAiResolution;
            }

            // Auto schedule checkbox change handler for panel
            autoScheduleEnabledPanel.addEventListener("change", () => {
                scheduleIntervalGroupPanel.style.display = autoScheduleEnabledPanel.checked ? "block" : "none";
                nextScheduleInfoPanel.style.display = autoScheduleEnabledPanel.checked ? "block" : "none";
                if (autoScheduleEnabledPanel.checked) {
                    nextScheduleDisplayPanel.textContent = calculateNextScheduleForPanel();
                }
            });

            // Schedule minutes change handler for panel
            scheduleMinutesPanel.addEventListener("input", () => {
                if (autoScheduleEnabledPanel.checked) {
                    nextScheduleDisplayPanel.textContent = calculateNextScheduleForPanel();
                }
            });

            // Save settings panel button handler
            saveSettingsPanelBtn.addEventListener("click", async () => {
                const pageId = getCurrentPageId();
                if (!pageId) {
                    alert("à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹€à¸žà¸ˆà¸à¹ˆà¸­à¸™");
                    return;
                }

                const autoSchedule = autoScheduleEnabledPanel.checked;
                const mins = scheduleMinutesPanel.value || "00, 15, 30, 45";
                const linkPrompt = linkPromptInput.value.trim();
                const imagePrompt = imagePromptInput.value.trim();
                const linkImageSize = getLinkImageSize();
                const imageImageSize = getImageImageSize();

                // Save AI prompts and image sizes to localStorage (per page) as backup
                localStorage.setItem(`linkPrompt_${pageId}`, linkPrompt);
                localStorage.setItem(`imagePrompt_${pageId}`, imagePrompt);
                localStorage.setItem(`linkImageSize_${pageId}`, linkImageSize);
                localStorage.setItem(`imageImageSize_${pageId}`, imageImageSize);

                // Save AI settings (global)
                localStorage.setItem("aiModel", aiModelSelect.value);
                localStorage.setItem("aiResolution", aiResolutionSelect.value);

                // Update cache immediately
                cachedPageSettings = {
                    pageId,
                    autoSchedule,
                    scheduleMinutes: mins
                };

                // Also update the modal settings (keep in sync)
                autoScheduleEnabled.checked = autoSchedule;
                scheduleMinutes.value = mins;
                scheduleIntervalGroup.style.display = autoSchedule ? "block" : "none";
                nextScheduleInfo.style.display = autoSchedule ? "block" : "none";

                // Save to database via API
                try {
                    // Save page settings
                    const response = await fetch('/api/page-settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            pageId,
                            autoSchedule,
                            scheduleMinutes: mins
                        })
                    });
                    const data = await response.json();

                    // Save prompts to database
                    if (linkPrompt) {
                        await fetch('/api/prompts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                pageId,
                                promptType: 'link_post',
                                promptText: linkPrompt
                            })
                        });
                    }
                    if (imagePrompt) {
                        await fetch('/api/prompts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                pageId,
                                promptType: 'image_post',
                                promptText: imagePrompt
                            })
                        });
                    }

                    if (data.success) {
                        console.log("[FEWFEED] Settings and prompts saved to database");
                        // Show success feedback
                        saveSettingsPanelBtn.textContent = "à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§ âœ“";
                        saveSettingsPanelBtn.style.background = "#10b981";
                        setTimeout(() => {
                            saveSettingsPanelBtn.textContent = "à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²";
                            saveSettingsPanelBtn.style.background = "";
                        }, 2000);
                    } else {
                        console.error("[FEWFEED] Failed to save settings:", data.error);
                        alert("à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: " + data.error);
                    }
                } catch (error) {
                    console.error("[FEWFEED] API error:", error);
                    alert("à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ");
                }

                updatePublishButton();
            });

            // Load settings on page load
            loadSettings();

            // Nav elements
            const dashboardNavItem =
                document.getElementById("dashboardNavItem");
            const imageNavItem = document.getElementById("imageNavItem");
            const reelsNavItem = document.getElementById("reelsNavItem");
            const pendingNavItem = document.getElementById("pendingNavItem");
            const quotesNavItem = document.getElementById("quotesNavItem");
            const pendingBadge = document.getElementById("pendingBadge");
            const pendingPanel = document.getElementById("pendingPanel");
            const quotesPanel = document.getElementById("quotesPanel");
            const settingsPanel = document.getElementById("settingsPanel");
            const pendingTableContainer = document.getElementById(
                "pendingTableContainer",
            );
            const previewPanel = document.querySelector(".preview-panel");
            const formPanel = document.querySelector(".form-panel");
            const appLayout = document.querySelector(".app-layout");

            // Sort state for pending posts (true = newest first, false = oldest/soonest first)
            let sortNewestFirst = true;
            const sortToggleBtn = document.getElementById("sortToggleBtn");

            function updateSortButton() {
                const icon = sortToggleBtn.querySelector(".sort-icon");
                const label = sortToggleBtn.querySelector(".sort-label");
                if (sortNewestFirst) {
                    icon.textContent = "â†“";
                    label.textContent = "à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸à¹ˆà¸­à¸™";
                } else {
                    icon.textContent = "â†‘";
                    label.textContent = "à¹‚à¸žà¸ªà¸•à¹Œà¹€à¸£à¹‡à¸§à¹†à¸™à¸µà¹‰à¸à¹ˆà¸­à¸™";
                }
            }

            if (sortToggleBtn) {
                sortToggleBtn.addEventListener("click", () => {
                    sortNewestFirst = !sortNewestFirst;
                    updateSortButton();
                    // Re-render with new sort order
                    const pageId = getCurrentPageId();
                    const cachedPosts = getCachedPosts(pageId);
                    if (cachedPosts) {
                        renderPendingPosts(cachedPosts);
                    }
                });
            }

            // Link-only elements (hidden in Image mode)
            const linkOnlyFields = document.getElementById("linkOnlyFields");
            const cardButtonGroup = document.getElementById("cardButtonGroup");
            const cardLinkInfo = document.getElementById("cardLinkInfo");

            // Current post mode: 'link' or 'image'
            let postMode = "link";

            // Update pending count from Facebook API
            async function updatePendingCount() {
                try {
                    const scheduledPosts =
                        await fetchScheduledPostsFromFacebook();
                    const count = scheduledPosts.length;
                    pendingBadge.textContent = count;
                    pendingBadge.style.display = count > 0 ? "inline" : "none";
                } catch (err) {
                    console.error("Failed to fetch pending count:", err);
                }
            }

            // Fetch scheduled posts from Facebook API
            async function fetchScheduledPostsFromFacebook() {
                const pageId = document.getElementById("pageSelect").value;
                // Use the specific Page Access Token (not User/Ads token)
                const selectedPageToken = localStorage.getItem(
                    "fewfeed_selectedPageToken",
                );

                console.log("[FEWFEED] Fetching scheduled posts:", {
                    hasPageId: !!pageId,
                    pageId: pageId || "(empty)",
                    hasSelectedPageToken: !!selectedPageToken,
                    tokenPrefix: selectedPageToken?.substring(0, 15) + "...",
                });

                if (!pageId || !selectedPageToken) {
                    console.log(
                        "[FEWFEED] Pages not loaded yet - showing skeleton",
                    );
                    return { loading: true };
                }

                const token = selectedPageToken;

                try {
                    const response = await fetch("/api/scheduled-posts", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ pageId, pageToken: token }),
                    });
                    const data = await response.json();

                    console.log("[FEWFEED] Scheduled posts response:", data);

                    if (data.success && data.posts) {
                        return data.posts;
                    } else {
                        console.error(
                            "[FEWFEED] Failed to fetch scheduled posts:",
                            data.error,
                        );
                        return { error: data.error || "à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸”à¹‰" };
                    }
                } catch (err) {
                    console.error(
                        "[FEWFEED] Error fetching scheduled posts:",
                        err,
                    );
                    return { error: "Connection error" };
                }
            }

            // Build pending table using DOM methods (safe from XSS)
            function buildPendingTable(posts) {
                const table = document.createElement("table");
                table.className = "pending-table";

                const thead = document.createElement("thead");
                const headerRow = document.createElement("tr");
                ["Type", "Image", "Message", "Scheduled", "Status", "Edit", "Delete"].forEach((text) => {
                    const th = document.createElement("th");
                    th.textContent = text;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement("tbody");
                posts.forEach((post) => {
                    const tr = document.createElement("tr");
                    tr.dataset.id = post.id;

                    // Type cell with icon
                    const typeTd = document.createElement("td");
                    const typeSpan = document.createElement("span");
                    const pType = post.postType || 'link';
                    typeSpan.className = `post-type-badge post-type-${pType}`;
                    const typeIcons = {
                        link: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',
                        image: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',
                        reels: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/><line x1="17" y1="17" x2="22" y2="17"/></svg>'
                    };
                    typeSpan.innerHTML = typeIcons[pType] || typeIcons.link;
                    typeSpan.title = pType.charAt(0).toUpperCase() + pType.slice(1);
                    typeTd.appendChild(typeSpan);
                    tr.appendChild(typeTd);

                    // Image cell (clickable to show lightbox, hover to preview)
                    const imgTd = document.createElement("td");
                    if (post.imageUrl) {
                        const img = document.createElement("img");
                        img.className = "pending-table-thumb";
                        img.alt = "";
                        img.loading = "lazy";
                        img.src = post.imageUrl; // Small thumbnail from Facebook
                        const fullUrl = post.fullImageUrl || post.imageUrl;
                        img.onclick = () => showLightbox(fullUrl);
                        img.onmouseenter = (e) => showThumbPreview(fullUrl, e);
                        img.onmousemove = (e) => moveThumbPreview(e);
                        img.onmouseleave = () => hideThumbPreview();
                        imgTd.appendChild(img);
                    } else {
                        const span = document.createElement("span");
                        span.style.color = "#999";
                        span.textContent = "No image";
                        imgTd.appendChild(span);
                    }
                    tr.appendChild(imgTd);

                    // Message cell
                    const msgTd = document.createElement("td");
                    const msgDiv = document.createElement("div");
                    msgDiv.className = "pending-table-title";
                    const message = post.message || "(No message)";
                    msgDiv.textContent =
                        message.length > 50
                            ? message.substring(0, 50) + "..."
                            : message;
                    msgDiv.title = message;
                    msgTd.appendChild(msgDiv);
                    tr.appendChild(msgTd);

                    // Scheduled time cell
                    const timeTd = document.createElement("td");
                    const timeSpan = document.createElement("span");
                    timeSpan.className = "pending-table-time";
                    timeSpan.textContent = post.scheduledTime
                        ? new Date(post.scheduledTime * 1000).toLocaleString(
                              "th-TH",
                              { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" }
                          )
                        : "-";
                    timeTd.appendChild(timeSpan);
                    tr.appendChild(timeTd);

                    // Status cell (clickable link to Facebook post)
                    const statusTd = document.createElement("td");
                    if (post.permalink || post.id) {
                        const statusLink = document.createElement("a");
                        statusLink.className = "pending-table-status";
                        statusLink.style.background = "#dcfce7";
                        statusLink.style.color = "#166534";
                        statusLink.textContent = "Scheduled";
                        statusLink.href =
                            post.permalink ||
                            `https://www.facebook.com/${post.id}`;
                        statusLink.target = "_blank";
                        statusLink.title = "View on Facebook";
                        statusTd.appendChild(statusLink);
                    } else {
                        const statusSpan = document.createElement("span");
                        statusSpan.className = "pending-table-status";
                        statusSpan.style.background = "#dcfce7";
                        statusSpan.style.color = "#166534";
                        statusSpan.textContent = "Scheduled";
                        statusTd.appendChild(statusSpan);
                    }
                    tr.appendChild(statusTd);

                    // Edit time cell
                    const editTd = document.createElement("td");
                    const editBtn = document.createElement("button");
                    editBtn.className = "pending-table-edit";
                    editBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
                    editBtn.title = "Edit scheduled time";
                    editBtn.onclick = () => editScheduledTime(post.id, post.scheduledTime);
                    editTd.appendChild(editBtn);
                    tr.appendChild(editTd);

                    // Delete cell
                    const deleteTd = document.createElement("td");
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "pending-table-delete";
                    deleteBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';
                    deleteBtn.title = "Delete post";
                    deleteBtn.onclick = () => deleteScheduledPost(post.id);
                    deleteTd.appendChild(deleteBtn);
                    tr.appendChild(deleteTd);

                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                return table;
            }

            // Edit scheduled time function - show modal
            function editScheduledTime(postId, currentTime) {
                const currentDate = currentTime ? new Date(currentTime * 1000) : new Date();

                // Create modal
                const modal = document.createElement("div");
                modal.className = "edit-time-modal";
                modal.innerHTML = `
                    <div class="edit-time-modal-content">
                        <h3>à¹à¸à¹‰à¹„à¸‚à¹€à¸§à¸¥à¸²à¹‚à¸žà¸ªà¸•à¹Œ</h3>
                        <div class="edit-time-fields">
                            <div class="edit-time-field">
                                <label>à¸§à¸±à¸™à¸—à¸µà¹ˆ</label>
                                <input type="date" id="editDateInput" value="${currentDate.toISOString().slice(0, 10)}">
                            </div>
                            <div class="edit-time-field">
                                <label>à¹€à¸§à¸¥à¸²</label>
                                <input type="time" id="editTimeInput" value="${currentDate.toTimeString().slice(0, 5)}">
                            </div>
                        </div>
                        <div class="edit-time-actions">
                            <button class="edit-time-cancel" onclick="this.closest('.edit-time-modal').remove()">à¸¢à¸à¹€à¸¥à¸´à¸</button>
                            <button class="edit-time-save" id="editTimeSaveBtn">à¸šà¸±à¸™à¸—à¸¶à¸</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Handle save
                document.getElementById("editTimeSaveBtn").onclick = async () => {
                    const dateVal = document.getElementById("editDateInput").value;
                    const timeVal = document.getElementById("editTimeInput").value;

                    if (!dateVal || !timeVal) {
                        alert("à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆà¹à¸¥à¸°à¹€à¸§à¸¥à¸²");
                        return;
                    }

                    const newTimestamp = Math.floor(new Date(dateVal + "T" + timeVal).getTime() / 1000);

                    try {
                        const pageToken = localStorage.getItem("fewfeed_selectedPageToken");
                        const response = await fetch("/api/update-post-time", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                postId,
                                pageToken,
                                scheduledTime: newTimestamp
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            modal.remove();
                            showPendingPanel();
                        } else {
                            alert("Error: " + (result.error || "Failed to update"));
                        }
                    } catch (err) {
                        alert("Error: " + err.message);
                    }
                };

            }

            // Delete scheduled post function - show modal
            function deleteScheduledPost(postId) {
                const modal = document.createElement("div");
                modal.className = "edit-time-modal";
                modal.innerHTML = `
                    <div class="edit-time-modal-content">
                        <h3>à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸¥à¸š</h3>
                        <p style="color: #6b7280; margin: 0 0 1.5rem 0; font-size: 0.9rem;">à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¹‚à¸žà¸ªà¸•à¹Œà¸™à¸µà¹‰à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ? à¸à¸²à¸£à¸¥à¸šà¸ˆà¸°à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸à¸¹à¹‰à¸„à¸·à¸™à¹„à¸”à¹‰</p>
                        <div class="edit-time-actions">
                            <button class="edit-time-cancel" onclick="this.closest('.edit-time-modal').remove()">à¸¢à¸à¹€à¸¥à¸´à¸</button>
                            <button class="delete-confirm-btn" id="deleteConfirmBtn">à¸¥à¸šà¹‚à¸žà¸ªà¸•à¹Œ</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Handle delete
                document.getElementById("deleteConfirmBtn").onclick = async () => {
                    const btn = document.getElementById("deleteConfirmBtn");
                    btn.textContent = "à¸à¸³à¸¥à¸±à¸‡à¸¥à¸š...";
                    btn.disabled = true;

                    try {
                        const pageToken = localStorage.getItem("fewfeed_selectedPageToken");
                        const response = await fetch("/api/delete-post", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ postId, pageToken })
                        });
                        const result = await response.json();
                        if (result.success) {
                            modal.remove();
                            // Invalidate cache after successful delete
                            invalidatePostsCache(getCurrentPageId());
                            // Remove just the row instead of reloading entire panel
                            const row = document.querySelector(`tr[data-id="${postId}"]`);
                            if (row) {
                                row.style.transition = "opacity 0.3s";
                                row.style.opacity = "0";
                                setTimeout(() => row.remove(), 300);
                            }
                            updatePendingCount();
                        } else {
                            alert("Error: " + (result.error || "Failed to delete"));
                            btn.textContent = "à¸¥à¸šà¹‚à¸žà¸ªà¸•à¹Œ";
                            btn.disabled = false;
                        }
                    } catch (err) {
                        alert("Error: " + err.message);
                        btn.textContent = "à¸¥à¸šà¹‚à¸žà¸ªà¸•à¹Œ";
                        btn.disabled = false;
                    }
                };

            }

            // Show pending panel (replaces both preview + form panels)
            // Render posts to table
            function renderPendingPosts(posts) {
                pendingTableContainer.textContent = "";
                if (!posts || posts.length === 0) {
                    const emptyDiv = document.createElement("div");
                    emptyDiv.className = "pending-empty";
                    emptyDiv.textContent = "No scheduled posts";
                    pendingTableContainer.appendChild(emptyDiv);
                } else {
                    // Sort based on user preference
                    const sorted = [...posts].sort((a, b) => {
                        const timeA = a.scheduledTime || 0;
                        const timeB = b.scheduledTime || 0;
                        // sortNewestFirst: true = newest scheduled time first (descending)
                        // sortNewestFirst: false = soonest to post first (ascending)
                        return sortNewestFirst ? (timeB - timeA) : (timeA - timeB);
                    });
                    const table = buildPendingTable(sorted);
                    pendingTableContainer.appendChild(table);
                }
            }

            // Check if posts arrays are different
            function postsChanged(oldPosts, newPosts) {
                if (!oldPosts || !newPosts) return true;
                if (oldPosts.length !== newPosts.length) return true;
                const oldIds = oldPosts.map(p => p.id).sort().join(",");
                const newIds = newPosts.map(p => p.id).sort().join(",");
                return oldIds !== newIds;
            }

            async function showPendingPanel(forceRefresh = false) {
                // Hide all mode containers
                document.querySelectorAll(".mode-container").forEach((c) => {
                    c.classList.remove("active");
                });
                // Hide quotes and settings panels
                quotesPanel.style.display = "none";
                settingsPanel.style.display = "none";
                // Lock body scroll
                document.body.style.overflow = "hidden";
                // Show pending panel (full width)
                pendingPanel.style.display = "flex";
                // Add pending mode class
                appLayout.classList.add("pending-mode");

                const pageId = getCurrentPageId();
                const cachedPosts = !forceRefresh ? getCachedPosts(pageId) : null;

                // Step 1: Show cached data immediately if available
                if (cachedPosts) {
                    console.log("[FEWFEED] Showing cached posts:", cachedPosts.length);
                    renderPendingPosts(cachedPosts);

                    // Step 2: Fetch fresh data in background
                    fetchScheduledPostsFromFacebook().then(result => {
                        if (result && result.loading) return;
                        if (result && result.error) {
                            console.error("[FEWFEED] Background refresh error:", result.error);
                            return;
                        }
                        const freshPosts = Array.isArray(result) ? result : [];

                        // Step 3: Update UI only if data changed
                        if (postsChanged(cachedPosts, freshPosts)) {
                            console.log("[FEWFEED] Posts changed, updating UI");
                            setCachedPosts(pageId, freshPosts);
                            renderPendingPosts(freshPosts);
                            updatePendingCount();
                        } else {
                            console.log("[FEWFEED] Posts unchanged, keeping cache");
                            // Update timestamp even if unchanged
                            setCachedPosts(pageId, freshPosts);
                        }
                    }).catch(err => {
                        console.error("[FEWFEED] Background refresh failed:", err);
                    });
                } else {
                    // No cache - show skeleton and fetch
                    pendingTableContainer.innerHTML = `
                        <div class="pending-skeleton">
                          <div class="pending-skeleton-row"><div class="sk-img"></div><div class="sk-text"></div><div class="sk-date"></div><div class="sk-badge"></div></div>
                          <div class="pending-skeleton-row"><div class="sk-img"></div><div class="sk-text"></div><div class="sk-date"></div><div class="sk-badge"></div></div>
                          <div class="pending-skeleton-row"><div class="sk-img"></div><div class="sk-text"></div><div class="sk-date"></div><div class="sk-badge"></div></div>
                        </div>
                    `;

                    try {
                        const result = await fetchScheduledPostsFromFacebook();

                        if (result && result.loading) return;

                        if (result && result.error) {
                            pendingTableContainer.textContent = "";
                            const errorDiv = document.createElement("div");
                            errorDiv.className = "pending-empty";
                            errorDiv.textContent = result.error;
                            pendingTableContainer.appendChild(errorDiv);
                            return;
                        }

                        const scheduledPosts = Array.isArray(result) ? result : [];
                        setCachedPosts(pageId, scheduledPosts);
                        renderPendingPosts(scheduledPosts);
                    } catch (err) {
                        console.error("Failed to fetch scheduled posts:", err);
                        pendingTableContainer.textContent = "";
                        const errorDiv = document.createElement("div");
                        errorDiv.className = "pending-empty";
                        errorDiv.textContent = "Failed to load from Facebook";
                        pendingTableContainer.appendChild(errorDiv);
                    }
                }
            }

            // Show dashboard (hide pending/quotes/settings panels, show mode containers)
            function showDashboard() {
                pendingPanel.style.display = "none";
                quotesPanel.style.display = "none";
                settingsPanel.style.display = "none";
                // Restore body scroll
                document.body.style.overflow = "";
                // Remove pending mode class
                appLayout.classList.remove("pending-mode");
            }

            // Show quotes panel
            function showQuotesPanel() {
                // Hide all mode containers
                document.querySelectorAll(".mode-container").forEach((c) => {
                    c.classList.remove("active");
                });
                pendingPanel.style.display = "none";
                settingsPanel.style.display = "none";
                quotesPanel.style.display = "flex";
                appLayout.classList.add("pending-mode");
                // Lock body scroll
                document.body.style.overflow = "hidden";
                // Load quotes
                loadQuotes();
            }

            // Show settings panel
            function showSettingsPanel() {
                // Hide all mode containers
                document.querySelectorAll(".mode-container").forEach((c) => {
                    c.classList.remove("active");
                });
                pendingPanel.style.display = "none";
                quotesPanel.style.display = "none";
                settingsPanel.style.display = "flex";
                appLayout.classList.add("pending-mode");
                // Lock body scroll
                document.body.style.overflow = "hidden";
                // Load settings for current page
                loadSettingsPanel();
            }

            // Quotes functionality
            const quotesTableContainer = document.getElementById("quotesTableContainer");
            const quoteInput = document.getElementById("quoteInput");
            const addQuoteBtn = document.getElementById("addQuoteBtn");

            let quotesOffset = 0;
            let quotesTotal = 0;
            let quotesHasMore = false;
            let quotesLoading = false;

            // Infinite scroll for quotes (using container scroll)
            quotesTableContainer.addEventListener("scroll", () => {
                if (quotesLoading || !quotesHasMore) return;
                const { scrollTop, scrollHeight, clientHeight } = quotesTableContainer;
                // Load more when 200px from bottom
                if (scrollTop + clientHeight >= scrollHeight - 200) {
                    loadQuotes(true);
                }
            });

            async function loadQuotes(append = false) {
                if (quotesLoading) return;
                quotesLoading = true;
                try {
                    if (!append) {
                        quotesOffset = 0;
                        quotesTableContainer.innerHTML = `
                            <div class="pending-skeleton">
                              <div class="pending-skeleton-row"><div class="sk-text" style="width: 80%;"></div><div class="sk-date"></div></div>
                              <div class="pending-skeleton-row"><div class="sk-text" style="width: 80%;"></div><div class="sk-date"></div></div>
                              <div class="pending-skeleton-row"><div class="sk-text" style="width: 80%;"></div><div class="sk-date"></div></div>
                            </div>
                        `;
                    }
                    const pageId = getCurrentPageId();
                    const response = await fetch(`/api/quotes?limit=50&offset=${quotesOffset}${pageId ? '&pageId=' + pageId : ''}`);
                    const data = await response.json();
                    if (data.success) {
                        quotesTotal = data.total;
                        quotesHasMore = data.hasMore;
                        quotesOffset += data.quotes.length;
                        renderQuotes(data.quotes, append);
                    } else {
                        quotesTableContainer.innerHTML = `<div class="pending-empty">${data.error}</div>`;
                    }
                } catch (error) {
                    console.error("[FEWFEED] Failed to load quotes:", error);
                    quotesTableContainer.innerHTML = `<div class="pending-empty">Failed to load quotes</div>`;
                } finally {
                    quotesLoading = false;
                }
            }

            function renderQuotes(quotes, append = false) {
                if (!append) {
                    quotesTableContainer.textContent = "";
                }

                if (!quotes || quotes.length === 0) {
                    if (!append) {
                        const emptyDiv = document.createElement("div");
                        emptyDiv.className = "pending-empty";
                        emptyDiv.textContent = "à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸³à¸„à¸¡";
                        quotesTableContainer.appendChild(emptyDiv);
                    }
                    return;
                }

                let table = quotesTableContainer.querySelector("table");
                let tbody;

                if (!table) {
                    table = document.createElement("table");
                    table.className = "pending-table";
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th style="width: 75%;">à¸„à¸³à¸„à¸¡</th>
                                <th style="width: 20%;">à¸§à¸±à¸™à¸—à¸µà¹ˆ</th>
                                <th style="width: 5%;"></th>
                            </tr>
                        </thead>
                    `;
                    tbody = document.createElement("tbody");
                    table.appendChild(tbody);
                    quotesTableContainer.appendChild(table);
                } else {
                    tbody = table.querySelector("tbody");
                }

                quotes.forEach(quote => {
                    const tr = document.createElement("tr");
                    tr.dataset.quoteId = quote.id;
                    tr.dataset.quoteText = quote.quote_text; // Store raw text in data attribute
                    if (quote.isUsed) {
                        tr.classList.add("quote-row-used");
                    }
                    const date = new Date(quote.created_at);
                    // Build HTML without extra whitespace in quote cell
                    const quoteHtml = escapeHtml(quote.quote_text.trim());
                    const badgeHtml = quote.isUsed ? ' <span class="quote-used-badge">à¹ƒà¸Šà¹‰à¹à¸¥à¹‰à¸§</span>' : '';
                    tr.innerHTML = `<td class="quote-text-cell" style="white-space: pre-wrap; word-break: break-word;" title="à¸”à¸±à¸šà¹€à¸šà¸´à¸¥à¸„à¸¥à¸´à¸à¹€à¸žà¸·à¹ˆà¸­à¹à¸à¹‰à¹„à¸‚">${quoteHtml}${badgeHtml}</td><td style="color: #888; font-size: 0.85rem;">${date.toLocaleDateString('th-TH')} ${date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}</td><td style="text-align: center;"><button onclick="deleteQuote(${quote.id}, this)" style="background: none; border: none; color: #e74c3c; cursor: pointer; padding: 0.5rem;" title="à¸¥à¸š"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></td>`;
                    // Add double-click handler for editing
                    const textCell = tr.querySelector('.quote-text-cell');
                    textCell.addEventListener('dblclick', () => startEditQuote(quote.id, textCell));
                    tbody.appendChild(tr);
                });
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            window.deleteQuote = async function(id, btn) {
                try {
                    const row = btn.closest("tr");
                    // Replace trash icon with spinner
                    const originalIcon = btn.innerHTML;
                    btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                        <circle cx="12" cy="12" r="10" stroke-dasharray="31.4" stroke-dashoffset="10"></circle>
                    </svg>`;
                    btn.disabled = true;

                    const response = await fetch(`/api/quotes?id=${id}`, { method: "DELETE" });
                    const data = await response.json();
                    if (data.success) {
                        if (row) row.remove();
                        const tbody = quotesTableContainer.querySelector("tbody");
                        if (tbody && tbody.children.length === 0) {
                            quotesTableContainer.innerHTML = '<div class="pending-empty">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸³à¸„à¸¡</div>';
                        }
                    } else {
                        btn.innerHTML = originalIcon;
                        btn.disabled = false;
                        alert("à¸¥à¸šà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: " + data.error);
                    }
                } catch (error) {
                    console.error("[FEWFEED] Failed to delete quote:", error);
                    alert("à¸¥à¸šà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
                }
            };

            // Inline quote editing
            function startEditQuote(quoteId, cell) {
                // Skip if already editing
                if (cell.querySelector('textarea')) return;

                // Get original text from data attribute (cleaner than textContent)
                const row = cell.closest('tr');
                const originalText = row.dataset.quoteText || cell.textContent.replace(/à¹ƒà¸Šà¹‰à¹à¸¥à¹‰à¸§$/, '').trim();
                const isUsed = row.classList.contains('quote-row-used');
                const textarea = document.createElement('textarea');
                textarea.value = originalText;
                textarea.style.cssText = `
                    width: 100%;
                    min-height: 100px;
                    max-height: 300px;
                    padding: 0.75rem;
                    border: 2px solid #9b59b6;
                    border-radius: 8px;
                    font-size: 0.95rem;
                    line-height: 1.5;
                    resize: vertical;
                    font-family: inherit;
                    background: #fff;
                    color: #333;
                    box-shadow: 0 2px 8px rgba(155, 89, 182, 0.2);
                    outline: none;
                    box-sizing: border-box;
                `;

                cell.textContent = '';
                cell.appendChild(textarea);
                textarea.focus();

                // Auto-resize textarea to fit content
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(Math.max(textarea.scrollHeight, 100), 300) + 'px';
                textarea.select();

                // Helper to rebuild cell content
                const rebuildCell = (text) => {
                    const badgeHtml = isUsed ? ' <span class="quote-used-badge">à¹ƒà¸Šà¹‰à¹à¸¥à¹‰à¸§</span>' : '';
                    cell.innerHTML = escapeHtml(text) + badgeHtml;
                    row.dataset.quoteText = text;
                };

                // Save on blur or Enter (Shift+Enter for new line)
                const saveEdit = async () => {
                    const newText = textarea.value.trim();
                    if (!newText) {
                        rebuildCell(originalText);
                        return;
                    }
                    if (newText === originalText.trim()) {
                        rebuildCell(originalText);
                        return;
                    }

                    textarea.disabled = true;
                    textarea.style.opacity = '0.5';

                    try {
                        const response = await fetch('/api/quotes', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: quoteId, quoteText: newText })
                        });
                        const data = await response.json();
                        if (data.success) {
                            rebuildCell(newText);
                        } else {
                            rebuildCell(originalText);
                            alert('à¹à¸à¹‰à¹„à¸‚à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ' + data.error);
                        }
                    } catch (error) {
                        console.error('[FEWFEED] Failed to update quote:', error);
                        rebuildCell(originalText);
                        alert('à¹à¸à¹‰à¹„à¸‚à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
                    }
                };

                let saving = false;
                textarea.addEventListener('blur', () => {
                    if (!saving) {
                        saving = true;
                        saveEdit();
                    }
                });
                textarea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (!saving) {
                            saving = true;
                            saveEdit();
                        }
                    }
                    if (e.key === 'Escape') {
                        rebuildCell(originalText);
                    }
                });
            }

            if (addQuoteBtn) {
                addQuoteBtn.addEventListener("click", async () => {
                    const text = quoteInput.value.trim();
                    if (!text) {
                        alert("à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸„à¸³à¸„à¸¡");
                        return;
                    }
                    try {
                        addQuoteBtn.disabled = true;
                        addQuoteBtn.textContent = "...";
                        const response = await fetch("/api/quotes", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ quoteText: text }),
                        });
                        const data = await response.json();
                        if (data.success) {
                            quoteInput.value = "";
                            loadQuotes();
                        } else {
                            alert("à¹€à¸žà¸´à¹ˆà¸¡à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: " + data.error);
                        }
                    } catch (error) {
                        console.error("[FEWFEED] Failed to add quote:", error);
                        alert("à¹€à¸žà¸´à¹ˆà¸¡à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
                    } finally {
                        addQuoteBtn.disabled = false;
                        addQuoteBtn.textContent = "à¹€à¸žà¸´à¹ˆà¸¡";
                    }
                });
            }

            // Enter key to add quote
            if (quoteInput) {
                quoteInput.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") {
                        addQuoteBtn.click();
                    }
                });
            }

            // Delete pending item
            window.deletePendingItem = async function (id) {
                try {
                    await fetch(`/api/queue/${id}`, { method: "DELETE" });
                    showPendingPanel(); // Refresh the table
                    updatePendingCount();
                } catch (err) {
                    console.error("Failed to delete pending item:", err);
                }
            };

            // Navigate to a specific page (updates URL hash)
            function navigateTo(page) {
                window.location.hash = page;
            }

            // Handle navigation based on URL hash
            function handleNavigation() {
                const hash = window.location.hash.slice(1) || "link"; // Default to 'link'

                // Update active state
                document
                    .querySelectorAll(".nav-item")
                    .forEach((item) => item.classList.remove("active"));

                if (hash === "pending") {
                    pendingNavItem.classList.add("active");
                    showPendingPanel();
                } else if (hash === "quotes") {
                    quotesNavItem.classList.add("active");
                    showQuotesPanel();
                } else if (hash === "settings") {
                    document.getElementById("settingsNavBtn").classList.add("active");
                    showSettingsPanel();
                } else if (hash === "image") {
                    imageNavItem.classList.add("active");
                    setPostMode("image");
                    showDashboard();
                } else if (hash === "reels") {
                    reelsNavItem.classList.add("active");
                    setPostMode("reels");
                    showDashboard();
                } else {
                    // Default: link
                    dashboardNavItem.classList.add("active");
                    setPostMode("link");
                    showDashboard();
                }
                // Re-validate after mode change
                validateLinkMode();
            }

            // Listen for hash changes (back/forward navigation)
            window.addEventListener("hashchange", handleNavigation);

            // Handle initial page load
            handleNavigation();

            // Pending nav item click
            pendingNavItem.addEventListener("click", (e) => {
                e.preventDefault();
                navigateTo("pending");
            });

            // Quotes nav item click
            quotesNavItem.addEventListener("click", (e) => {
                e.preventDefault();
                navigateTo("quotes");
            });

            // Settings nav item click
            document.getElementById("settingsNavBtn").addEventListener("click", (e) => {
                e.preventDefault();
                navigateTo("settings");
            });

            // Link nav item click (Dashboard renamed to Link)
            dashboardNavItem.addEventListener("click", (e) => {
                e.preventDefault();
                navigateTo("link");
            });

            // Image nav item click
            imageNavItem.addEventListener("click", (e) => {
                e.preventDefault();
                navigateTo("image");
            });

            reelsNavItem.addEventListener("click", (e) => {
                e.preventDefault();
                navigateTo("reels");
            });

            // Set post mode (link, image, or reels) - toggle mode containers
            function setPostMode(mode) {
                postMode = mode;

                // Hide all mode containers
                document.querySelectorAll(".mode-container").forEach((c) => {
                    c.classList.remove("active");
                });

                // Show selected mode container
                const containerId = `${mode}ModeContainer`;
                const container = document.getElementById(containerId);
                if (container) {
                    container.classList.add("active");
                }
            }

            // Update pending count on load
            updatePendingCount();
            // Refresh pending count every 30 seconds
            setInterval(updatePendingCount, 30000);

            // Preview elements
            const previewCaption = document.getElementById("previewCaption");
            const previewDescription =
                document.getElementById("previewDescription");
            const previewCardButton =
                document.getElementById("previewCardButton");
            const cardButtonText = document.getElementById("cardButtonText");
            const cardButtonDropdown =
                document.getElementById("cardButtonDropdown");
            const cardButtonSelect = document.getElementById("cardButton");

            // Toggle dropdown on button click
            previewCardButton.addEventListener("click", (e) => {
                e.stopPropagation();
                cardButtonDropdown.classList.toggle("show");
            });

            // Handle option selection
            cardButtonDropdown.addEventListener("click", (e) => {
                const option = e.target.closest(".card-button-option");
                if (option) {
                    const value = option.dataset.value;
                    const label = option.textContent;

                    // Update button text
                    cardButtonText.textContent = label;

                    // Update hidden select
                    cardButtonSelect.value = value;

                    // Update selected state
                    cardButtonDropdown
                        .querySelectorAll(".card-button-option")
                        .forEach((opt) => {
                            opt.classList.remove("selected");
                        });
                    option.classList.add("selected");

                    // Close dropdown
                    cardButtonDropdown.classList.remove("show");
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener("click", () => {
                cardButtonDropdown.classList.remove("show");
            });

            // State per mode - each mode has independent state
            const modeState = {
                link: {
                    referenceImages: [],
                    generatedImages: [],
                    selectedImage: null,
                    currentView: "upload",
                },
                image: {
                    referenceImages: [],
                    generatedImages: [],
                    selectedImage: null,
                    currentView: "upload",
                },
                reels: {
                    referenceImages: [],
                    generatedImages: [],
                    selectedImage: null,
                    currentView: "upload",
                },
            };

            // Helper to get current mode state
            function getState() {
                return modeState[postMode] || modeState.link;
            }

            // Helper to get mode-specific DOM elements
            function getModeElements(mode = postMode) {
                const prefix = mode === "link" ? "" : mode; // Link mode uses original IDs without prefix
                const capitalize = (s) =>
                    s.charAt(0).toUpperCase() + s.slice(1);

                if (mode === "link") {
                    return {
                        cardImageArea: document.getElementById("cardImageArea"),
                        uploadPrompt: document.getElementById("uploadPrompt"),
                        uploadFromDevice:
                            document.getElementById("uploadFromDevice"),
                        uploadFromGemini:
                            document.getElementById("uploadFromGemini"),
                        generateOverlay:
                            document.getElementById("generateOverlay"),
                        generateBtn: document.getElementById("generateBtn"),
                        refThumbsRow: document.getElementById("refThumbsRow"),
                        generatedGrid: document.getElementById("generatedGrid"),
                        skeletonGrid: document.getElementById("skeletonGrid"),
                        fullImageView: document.getElementById("fullImageView"),
                        primaryText: document.getElementById("primaryText"),
                        publishBtn: document.getElementById("publishBtn"),
                    };
                } else {
                    return {
                        cardImageArea: document.getElementById(
                            `${mode}CardImageArea`,
                        ),
                        uploadPrompt: document.getElementById(
                            `${mode}UploadPrompt`,
                        ),
                        uploadFromDevice: document.getElementById(
                            `${mode}UploadFromDevice`,
                        ),
                        uploadFromGemini: document.getElementById(
                            `${mode}UploadFromGemini`,
                        ),
                        generateOverlay: document.getElementById(
                            `${mode}GenerateOverlay`,
                        ),
                        generateBtn: document.getElementById(
                            `${mode}GenerateBtn`,
                        ),
                        refThumbsRow: document.getElementById(
                            `${mode}RefThumbsRow`,
                        ),
                        generatedGrid: document.getElementById(
                            `${mode}GeneratedGrid`,
                        ),
                        skeletonGrid: document.getElementById(
                            `${mode}SkeletonGrid`,
                        ),
                        fullImageView: document.getElementById(
                            `${mode}FullImageView`,
                        ),
                        primaryText: document.getElementById(
                            `${mode}PrimaryText`,
                        ),
                        publishBtn: document.getElementById(
                            `${mode}PublishBtn`,
                        ),
                    };
                }
            }

            // ============================================
            // LAZADA AFFILIATE LINK CONVERSION (Auto-convert)
            // ============================================
            const lazadaStatus = document.getElementById("lazadaStatus");
            let isConverting = false;

            // Check if URL is a Lazada product URL
            function isLazadaUrl(url) {
                return (
                    url &&
                    (url.includes("lazada.co.th/products/") ||
                        url.includes("lazada.co.th/products/-"))
                );
            }

            // Convert Lazada URL to affiliate link
            async function convertLazadaLink() {
                if (isConverting) return;

                const url = linkUrl.value.trim();

                if (!url || !isLazadaUrl(url)) {
                    return;
                }

                // Show loading state
                isConverting = true;
                lazadaStatus.textContent = "Converting...";
                lazadaStatus.style.color = "#888";

                // Send message to extension
                window.postMessage(
                    {
                        type: "FEWFEED_CONVERT_LAZADA_LINK",
                        productUrl: url,
                    },
                    "*",
                );
            }

            // Listen for Lazada conversion response
            window.addEventListener("message", (event) => {
                if (event.data.type === "FEWFEED_LAZADA_LINK_RESPONSE") {
                    const response = event.data.data;
                    isConverting = false;

                    if (response.success && response.affiliateLink) {
                        // Update the link URL field with affiliate link
                        linkUrl.value = response.affiliateLink;
                        lazadaStatus.textContent = "";
                    } else {
                        lazadaStatus.textContent =
                            "âŒ " + (response.error || "Conversion failed");
                        lazadaStatus.style.color = "#ef4444";
                    }
                }
            });

            // Clean Lazada URL - remove query params after .html
            function cleanLazadaUrl(url) {
                if (
                    url.includes("lazada.co.th/products/") &&
                    url.includes(".html")
                ) {
                    return url.split(".html")[0] + ".html";
                }
                return url;
            }

            // Auto-convert Lazada URL on paste
            if (linkUrl) linkUrl.addEventListener("paste", (e) => {
                // Wait for the paste to complete
                setTimeout(() => {
                    let url = linkUrl.value.trim();
                    // Clean up Lazada URL first
                    url = cleanLazadaUrl(url);
                    linkUrl.value = url;

                    if (isLazadaUrl(url) && !url.includes("s.lazada.co.th")) {
                        // Auto-convert!
                        convertLazadaLink();
                    }
                }, 100);
            });

            // ============================================

            // Track which upload mode was clicked
            let uploadMode = "gemini"; // 'device' or 'gemini'

            // Setup upload button handlers for each mode
            function setupUploadHandlers(mode) {
                const els = getModeElements(mode);
                if (!els.uploadFromDevice || !els.uploadFromGemini) return;

                els.uploadFromDevice.addEventListener("click", (e) => {
                    e.stopPropagation();
                    uploadMode = "device";
                    fileInput.click();
                });

                els.uploadFromGemini.addEventListener("click", async (e) => {
                    e.stopPropagation();
                    // Directly trigger generate without needing to upload
                    if (els.generateBtn) {
                        els.generateBtn.click();
                    }
                });

                // Click on card image area (for other areas)
                if (els.cardImageArea) {
                    els.cardImageArea.addEventListener("click", (e) => {
                        if (
                            e.target.closest(".btn-generate") ||
                            e.target.closest(".generated-item") ||
                            e.target.closest(".back-to-grid") ||
                            e.target.closest(".upload-btn")
                        ) {
                            return;
                        }
                        const state = modeState[mode];
                        if (
                            state.currentView === "upload" ||
                            state.currentView === "refs"
                        ) {
                            uploadMode = "gemini";
                            fileInput.click();
                        }
                    });
                }
            }

            // Setup handlers for all modes
            setupUploadHandlers("link");
            setupUploadHandlers("image");
            setupUploadHandlers("reels");

            // File input change - handle both device upload and gemini generation
            fileInput.addEventListener("change", async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                // Get current mode's state and elements
                const state = getState();
                const els = getModeElements();

                if (uploadMode === "device") {
                    // Direct upload - just show the image
                    const file = files[0]; // Use first file only
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        state.selectedImage = ev.target.result;

                        // Show image in full view
                        state.currentView = "full";
                        els.uploadPrompt.style.display = "none";
                        els.refThumbsRow.style.display = "none";
                        els.generateOverlay.style.display = "none";
                        els.generatedGrid.style.display = "none";
                        els.skeletonGrid.style.display = "none";

                        els.fullImageView.style.display = "block";
                        // Create image element
                        const imgEl = document.createElement("img");
                        imgEl.src = state.selectedImage;
                        imgEl.style.cssText =
                            "width: 100%; height: 100%; object-fit: contain;";

                        const backBtn = document.createElement("button");
                        backBtn.className = "back-to-upload";
                        backBtn.style.cssText =
                            "position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); border: none; border-radius: 8px; padding: 8px; cursor: pointer; color: white;";
                        backBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>`;

                        els.fullImageView.textContent = "";
                        els.fullImageView.appendChild(imgEl);
                        els.fullImageView.appendChild(backBtn);

                        // Add click handler for back button (capture current mode)
                        const currentMode = postMode;
                        backBtn.addEventListener("click", (ev) => {
                            ev.stopPropagation();
                            const s = modeState[currentMode];
                            const e = getModeElements(currentMode);
                            s.selectedImage = null;
                            s.currentView = "upload";
                            e.fullImageView.style.display = "none";
                            e.uploadPrompt.style.display = "flex";
                        });

                        // Update preview
                        els.publishBtn.classList.remove("published");
                        lastPublishedUrl = null;
                    };
                    reader.readAsDataURL(file);
                    fileInput.value = "";
                    return;
                }

                // Gemini mode - generate variations
                // Show skeleton grid immediately
                state.currentView = "generating";
                els.uploadPrompt.style.display = "none";
                els.refThumbsRow.style.display = "none";
                els.generateOverlay.style.display = "none";
                els.generatedGrid.style.display = "none";
                els.skeletonGrid.style.display = "grid";

                // Read all files first
                state.referenceImages = [];
                const readPromises = files.map((file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            resolve({
                                data: ev.target.result.split(",")[1],
                                mimeType: file.type,
                            });
                        };
                        reader.readAsDataURL(file);
                    });
                });

                state.referenceImages = await Promise.all(readPromises);
                fileInput.value = "";

                // Generate immediately
                try {
                    const response = await fetch("/api/generate", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            referenceImages: state.referenceImages,
                            aspectRatio: getCurrentAspectRatio(),
                            model: localStorage.getItem("aiModel") || "gemini-2.0-flash-exp",
                        }),
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    state.generatedImages = data.images;
                    showGeneratedGrid();
                } catch (err) {
                    alert("Generation failed: " + err.message);
                    // Reset to upload state
                    state.currentView = "upload";
                    els.uploadPrompt.style.display = "flex";
                    els.generateOverlay.style.display = "none";
                    els.skeletonGrid.style.display = "none";
                }
            });

            // Update reference thumbnails (uses current mode)
            function updateRefThumbs() {
                const state = getState();
                const els = getModeElements();

                els.refThumbsRow.textContent = "";
                state.referenceImages.forEach((img, i) => {
                    const thumb = document.createElement("img");
                    thumb.className = "ref-thumb";
                    thumb.src = `data:${img.mimeType};base64,${img.data}`;
                    els.refThumbsRow.appendChild(thumb);
                });

                // Add plus button
                const plus = document.createElement("div");
                plus.className = "ref-thumb";
                plus.innerHTML =
                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
                plus.addEventListener("click", (e) => {
                    e.stopPropagation();
                    fileInput.click();
                });
                els.refThumbsRow.appendChild(plus);

                els.uploadPrompt.style.display = "none";
                els.refThumbsRow.style.display = "flex";
                els.generateOverlay.style.display = "flex";
            }

            // Setup generate button handlers for each mode
            function setupGenerateHandler(mode) {
                const els = getModeElements(mode);
                if (!els.generateBtn) return;

                els.generateBtn.addEventListener("click", async (e) => {
                    e.stopPropagation();
                    const state = modeState[mode];

                    els.generateBtn.disabled = true;
                    els.generateBtn.innerHTML =
                        '<span class="loading"></span> Generating...';

                    // Show skeleton loading immediately (single card)
                    state.currentView = "generating";
                    els.uploadPrompt.style.display = "none";
                    els.generateOverlay.style.display = "none";
                    els.refThumbsRow.style.display = "none";
                    els.generatedGrid.style.display = "none";
                    els.fullImageView.style.display = "none";

                    // Show single skeleton card
                    els.skeletonGrid.innerHTML = '<div class="skeleton-card"></div>';
                    els.skeletonGrid.classList.add('single');
                    els.skeletonGrid.style.display = "grid";

                    try {
                        const pageId = getCurrentPageId();
                        let caption = "";

                        // For link mode: auto-fetch unused quote
                        if (mode === "link" && pageId) {
                            // Fetch quotes and find unused one
                            const quotesRes = await fetch(`/api/quotes?limit=100&pageId=${pageId}`);
                            const quotesData = await quotesRes.json();

                            if (quotesData.success && quotesData.quotes.length > 0) {
                                // Find first unused quote
                                const unusedQuote = quotesData.quotes.find(q => !q.isUsed);

                                if (unusedQuote) {
                                    caption = unusedQuote.quote_text;

                                    // Mark as used
                                    await fetch('/api/quotes', {
                                        method: 'PATCH',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ id: unusedQuote.id, pageId })
                                    });

                                    state.lastUsedQuoteId = unusedQuote.id;
                                    console.log('[FEWFEED] Auto-selected quote:', unusedQuote.id);
                                } else {
                                    // Use caption field value if no unused quotes
                                    const captionField = document.getElementById("caption");
                                    caption = captionField ? captionField.value : "";
                                    console.log('[FEWFEED] No unused quotes, using caption field');
                                }
                            }
                        } else {
                            // For other modes, get caption from field
                            const captionField = document.getElementById("caption");
                            caption = captionField ? captionField.value : "";
                        }

                        // Get aspect ratio based on mode
                        const storageKey = mode === "link" ? `linkImageSize_${pageId}` : `imageImageSize_${pageId}`;
                        const aspectRatio = localStorage.getItem(storageKey) || "1:1";

                        // Get AI settings - load prompt from database with fallback to localStorage
                        const promptType = mode === "link" ? "link_post" : "image_post";
                        let customPrompt = "";
                        try {
                            // Try page-specific prompt first
                            const promptRes = await fetch(`/api/prompts?pageId=${pageId}&promptType=${promptType}`);
                            const promptData = await promptRes.json();
                            if (promptData.success && promptData.prompts.length > 0) {
                                customPrompt = promptData.prompts[0].prompt_text;
                            } else {
                                // Try default prompt
                                const defaultRes = await fetch(`/api/prompts?pageId=_default&promptType=${promptType}`);
                                const defaultData = await defaultRes.json();
                                if (defaultData.success && defaultData.prompts.length > 0) {
                                    customPrompt = defaultData.prompts[0].prompt_text;
                                } else {
                                    // Fallback to localStorage
                                    const promptKey = mode === "link" ? `linkPrompt_${pageId}` : `imagePrompt_${pageId}`;
                                    customPrompt = localStorage.getItem(promptKey) || "";
                                }
                            }
                        } catch (e) {
                            console.warn('[FEWFEED] Failed to load prompt from DB, using localStorage');
                            const promptKey = mode === "link" ? `linkPrompt_${pageId}` : `imagePrompt_${pageId}`;
                            customPrompt = localStorage.getItem(promptKey) || "";
                        }
                        const resolution = localStorage.getItem("aiResolution") || "2K";

                        // Build request body
                        const requestBody = {
                            aspectRatio: aspectRatio,
                            model: localStorage.getItem("aiModel") || "gemini-2.0-flash-exp",
                            numberOfImages: 1,
                            caption: caption,
                            resolution: resolution,
                            customPrompt: customPrompt,
                        };

                        // Add reference images if available
                        if (state.referenceImages.length > 0) {
                            requestBody.referenceImages = state.referenceImages;
                        }

                        const response = await fetch("/api/generate", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(requestBody),
                        });

                        const data = await response.json();
                        if (data.error) throw new Error(data.error);

                        state.generatedImages = data.images;

                        // Show single image full-size directly
                        if (data.images && data.images.length === 1) {
                            showSingleImage(data.images[0]);
                        } else {
                            showGeneratedGrid();
                        }
                    } catch (err) {
                        alert("Generation failed: " + err.message);
                        // Go back to upload prompt on error
                        els.skeletonGrid.style.display = "none";
                        els.skeletonGrid.classList.remove('single');
                        els.uploadPrompt.style.display = "flex";
                        state.currentView = "upload";
                    } finally {
                        els.generateBtn.disabled = false;
                        els.generateBtn.innerHTML =
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Generate';
                    }
                });
            }

            // Setup generate handlers for all modes
            setupGenerateHandler("link");
            setupGenerateHandler("image");
            setupGenerateHandler("reels");

            // Show single generated image full-size
            function showSingleImage(imgSrc) {
                const state = getState();
                const els = getModeElements();

                state.currentView = "single";
                state.selectedImage = imgSrc;
                els.uploadPrompt.style.display = "none";
                els.generateOverlay.style.display = "none";
                els.refThumbsRow.style.display = "none";
                els.skeletonGrid.style.display = "none";
                els.skeletonGrid.classList.remove('single');
                els.generatedGrid.style.display = "none";
                els.fullImageView.style.display = "flex";

                // Build the full image view
                els.fullImageView.textContent = "";
                els.fullImageView.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    width: 100%;
                    height: 100%;
                    background: #1a1a1a;
                    position: relative;
                `;

                const imgEl = document.createElement("img");
                imgEl.src = imgSrc;
                imgEl.alt = "Generated Image";
                imgEl.style.cssText = `
                    max-width: 100%;
                    max-height: 100%;
                    object-fit: contain;
                    border-radius: 8px;
                `;
                els.fullImageView.appendChild(imgEl);

                // Add buttons at top
                const btnContainer = document.createElement("div");
                btnContainer.style.cssText = `
                    position: absolute;
                    top: 12px;
                    right: 12px;
                    display: flex;
                    gap: 8px;
                    z-index: 10;
                `;

                // Delete button
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "btn-regenerate";
                deleteBtn.style.cssText = "background: #dc3545;";
                deleteBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> à¸¥à¸šà¸£à¸¹à¸›';
                deleteBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    state.currentView = "upload";
                    state.selectedImage = null;
                    els.fullImageView.style.display = "none";
                    els.fullImageView.textContent = "";
                    els.uploadPrompt.style.display = "flex";
                });
                btnContainer.appendChild(deleteBtn);

                // Regenerate button
                const regenBtn = document.createElement("button");
                regenBtn.className = "btn-regenerate";
                regenBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> à¹€à¸ˆà¸™à¹ƒà¸«à¸¡à¹ˆ';
                regenBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    // Trigger generate again
                    els.generateBtn.click();
                });
                btnContainer.appendChild(regenBtn);
                els.fullImageView.appendChild(btnContainer);
            }

            // Show generated grid (uses current mode)
            function showGeneratedGrid() {
                const state = getState();
                const els = getModeElements();

                state.currentView = "grid";
                els.uploadPrompt.style.display = "none";
                els.generateOverlay.style.display = "none";
                els.refThumbsRow.style.display = "none";
                els.skeletonGrid.style.display = "none";
                els.generatedGrid.style.display = "grid";
                els.fullImageView.style.display = "none";

                els.generatedGrid.textContent = "";

                // Add regenerate button
                const regenBtn = document.createElement("button");
                regenBtn.className = "btn-regenerate";
                regenBtn.innerHTML =
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> à¹€à¸ˆà¸™à¹ƒà¸«à¸¡à¹ˆ';
                regenBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    regenerateImages();
                });
                els.generatedGrid.appendChild(regenBtn);

                state.generatedImages.forEach((img, i) => {
                    const item = document.createElement("div");
                    item.className = "generated-item";
                    const numSpan = document.createElement("span");
                    numSpan.className = "item-number";
                    numSpan.textContent = i + 1;
                    const imgEl = document.createElement("img");
                    imgEl.src = img;
                    imgEl.alt = `Generated ${i + 1}`;
                    item.appendChild(numSpan);
                    item.appendChild(imgEl);
                    item.addEventListener("click", (e) => {
                        e.stopPropagation();
                        selectImage(img, item);
                    });
                    els.generatedGrid.appendChild(item);
                });
            }

            // Regenerate images (uses current mode)
            async function regenerateImages() {
                const state = getState();
                const els = getModeElements();

                if (state.referenceImages.length === 0) {
                    fileInput.click();
                    return;
                }

                state.currentView = "generating";
                els.generatedGrid.style.display = "none";
                els.generateOverlay.style.display = "none";
                els.skeletonGrid.style.display = "grid";

                try {
                    // Get caption from field
                    const captionField = document.getElementById("caption");
                    const caption = captionField ? captionField.value : "";

                    // Build request body
                    const requestBody = {
                        aspectRatio: getCurrentAspectRatio(),
                        model: localStorage.getItem("aiModel") || "gemini-2.0-flash-exp",
                        numberOfImages: 1,
                        caption: caption,
                    };

                    // Add reference images if available
                    if (state.referenceImages.length > 0) {
                        requestBody.referenceImages = state.referenceImages;
                    }

                    const response = await fetch("/api/generate", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(requestBody),
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    state.generatedImages = data.images;
                    showGeneratedGrid();
                } catch (err) {
                    alert("Generation failed: " + err.message);
                    showGeneratedGrid(); // Show previous results
                }
            }

            // Select an image (uses current mode)
            function selectImage(imgSrc, element) {
                const state = getState();
                const els = getModeElements();

                els.generatedGrid
                    .querySelectorAll(".generated-item")
                    .forEach((el) => el.classList.remove("selected"));
                if (element) element.classList.add("selected");
                state.selectedImage = imgSrc;
                showFullImage(imgSrc);
            }

            // Show full image (uses current mode)
            function showFullImage(imgSrc) {
                const state = getState();
                const els = getModeElements();

                state.currentView = "full";
                els.uploadPrompt.style.display = "none";
                els.generateOverlay.style.display = "none";
                els.refThumbsRow.style.display = "none";
                els.generatedGrid.style.display = "none";
                els.fullImageView.style.display = "flex";

                // Create elements instead of innerHTML
                els.fullImageView.textContent = "";
                const backBtn = document.createElement("button");
                backBtn.className = "back-to-grid";
                backBtn.innerHTML =
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Back to grid';
                backBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    showGeneratedGrid();
                });
                const imgEl = document.createElement("img");
                imgEl.src = imgSrc;
                imgEl.alt = "Selected";
                els.fullImageView.appendChild(backBtn);
                els.fullImageView.appendChild(imgEl);
            }

            // Update preview on input change
            caption.addEventListener(
                "input",
                () => (previewCaption.textContent = caption.value),
            );
            description.addEventListener(
                "input",
                () => (previewDescription.textContent = description.value),
            );

            // Double-click to edit preview text
            function setupEditableText(previewEl, inputEl) {
                previewEl.addEventListener("dblclick", () => {
                    previewEl.contentEditable = "true";
                    previewEl.classList.add("editing");
                    previewEl.focus();
                    // Select all text
                    const range = document.createRange();
                    range.selectNodeContents(previewEl);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                });

                previewEl.addEventListener("blur", () => {
                    previewEl.contentEditable = "false";
                    previewEl.classList.remove("editing");
                    inputEl.value = previewEl.textContent;
                });

                previewEl.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        previewEl.blur();
                    }
                    if (e.key === "Escape") {
                        previewEl.textContent = inputEl.value;
                        previewEl.blur();
                    }
                });
            }

            setupEditableText(previewCaption, caption);
            setupEditableText(previewDescription, description);

            // Publish
            let lastPublishedUrl = null;

            // Setup publish handler for each mode
            function setupPublishHandler(mode) {
                const els = getModeElements(mode);
                if (!els.publishBtn) return;

                els.publishBtn.addEventListener("click", async () => {
                    const state = modeState[mode];

                    // If already published, open the URL in background
                    if (
                        lastPublishedUrl &&
                        els.publishBtn.classList.contains("published")
                    ) {
                        // Reset button after viewing
                        els.publishBtn.textContent = "SCHEDULE";
                        els.publishBtn.classList.remove("published");
                        lastPublishedUrl = null;
                        return;
                    }

                    if (!state.selectedImage) {
                        alert("Please select an image first");
                        return;
                    }

                    els.publishBtn.disabled = true;
                    els.publishBtn.innerHTML = '<span class="loading"></span>';
                    els.publishBtn.classList.remove("published");
                    lastPublishedUrl = null;

                    try {
                        const pageId =
                            document.getElementById("pageSelect").value;

                        if (!pageId) {
                            throw new Error("à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸ Page");
                        }

                        // ========== IMAGE MODE: Use Graph API directly ==========
                        if (mode === "image") {
                            const pageToken = localStorage.getItem("fewfeed_selectedPageToken");
                            if (!pageToken) {
                                throw new Error("à¹„à¸¡à¹ˆà¸¡à¸µ Page Token à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸ Page à¹ƒà¸«à¸¡à¹ˆ");
                            }

                            const message = els.primaryText?.value || "";
                            let imageUrl = state.selectedImage;

                            // Compress and upload base64 image
                            if (imageUrl.startsWith("data:")) {
                                console.log("[FEWFEED] Compressing image...");
                                imageUrl = await compressImage(imageUrl, 1200, 0.8);
                                console.log("[FEWFEED] Uploading compressed image...");
                                const uploadRes = await fetch("/api/upload-image", {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({ imageData: imageUrl }),
                                });
                                const uploadData = await uploadRes.json();
                                if (!uploadData.success) {
                                    throw new Error(uploadData.error || "Image upload failed");
                                }
                                imageUrl = uploadData.url;
                                console.log("[FEWFEED] Image uploaded:", imageUrl);
                            }

                            // Check if auto-schedule is enabled (use cached settings from database)
                            const isAutoSchedule = cachedPageSettings.pageId === pageId && cachedPageSettings.autoSchedule;
                            let scheduledTime = null;
                            if (isAutoSchedule) {
                                // Refresh scheduled times from Facebook to avoid duplicates
                                await refreshScheduledPostTimes();
                                scheduledTime = getNextScheduleTime();
                                // Add to local cache immediately to prevent duplicates in rapid succession
                                scheduledPostTimes.push(scheduledTime);
                                console.log("[FEWFEED] Image scheduling for:", scheduledTime.toISOString());
                            }

                            console.log("[FEWFEED] Publishing image via Graph API...");

                            // Build form data for Graph API
                            const formData = new FormData();
                            formData.append("url", imageUrl);
                            if (message) formData.append("message", message);
                            formData.append("access_token", pageToken);

                            // If scheduling, set published=false and scheduled_publish_time
                            if (scheduledTime) {
                                formData.append("published", "false");
                                formData.append("scheduled_publish_time", Math.floor(scheduledTime.getTime() / 1000));
                            }

                            const response = await fetch(`https://graph.facebook.com/v21.0/${pageId}/photos`, {
                                method: "POST",
                                body: formData,
                            });

                            const data = await response.json();
                            console.log("[FEWFEED] Graph API response:", data);

                            if (data.error) {
                                throw new Error(data.error.message);
                            }

                            // Success!
                            const postId = data.post_id || data.id;
                            lastPublishedUrl = `https://www.facebook.com/${postId}`;

                            els.publishBtn.textContent = "âœ“";
                            els.publishBtn.classList.add("published");
                            els.publishBtn.disabled = false;

                            // Refresh scheduled times from Facebook
                            if (scheduledTime) {
                                await refreshScheduledPostTimes();
                                updateNextScheduleDisplay();

                                // Navigate to pending page after 1 second, then clear image silently
                                setTimeout(() => {
                                    window.location.hash = "#pending";
                                    handleNavigation();
                                    // Clear the uploaded image after navigation
                                    state.selectedImage = null;
                                    state.currentView = "upload";
                                    if (els.fullImageView) els.fullImageView.style.display = "none";
                                    if (els.uploadPrompt) els.uploadPrompt.style.display = "flex";
                                    els.publishBtn.textContent = "SCHEDULE";
                                    els.publishBtn.classList.remove("published");
                                }, 1000);
                            }

                            return; // Exit early for image mode
                        }

                        // ========== LINK MODE: Use Ads API ==========
                        // Get credentials - Only Ads Token + Cookie needed
                        // Server fetches Page Token directly from Ads Token (no Postcron needed)
                        const adsToken =
                            fbToken ||
                            localStorage.getItem("fewfeed_accessToken") ||
                            localStorage.getItem("fewfeed_token");
                        const cookie =
                            fbCookie || localStorage.getItem("fewfeed_cookie");
                        const adAccountId =
                            document.getElementById("adAccountSelect").value;

                        if (!adsToken) {
                            throw new Error(
                                "à¹„à¸¡à¹ˆà¸¡à¸µ Ads Token à¸à¸£à¸¸à¸“à¸²à¸„à¸¥à¸´à¸ icon extension à¹€à¸žà¸·à¹ˆà¸­ login",
                            );
                        }

                        if (!cookie) {
                            throw new Error(
                                "à¹„à¸¡à¹ˆà¸¡à¸µ Cookie à¸à¸£à¸¸à¸“à¸²à¸„à¸¥à¸´à¸ icon extension à¹€à¸žà¸·à¹ˆà¸­ login",
                            );
                        }

                        console.log(
                            "[FEWFEED] Publishing with Ads Token only (server fetches Page Token)",
                        );

                        // Check if auto-schedule is enabled (use cached settings from database)
                        const isAutoSchedule = cachedPageSettings.pageId === pageId && cachedPageSettings.autoSchedule;
                        let scheduledTime = null;
                        if (isAutoSchedule) {
                            // Refresh scheduled times from Facebook to avoid duplicates
                            await refreshScheduledPostTimes();
                            scheduledTime = getNextScheduleTime();
                            // Add to local cache immediately to prevent duplicates in rapid succession
                            scheduledPostTimes.push(scheduledTime);
                            console.log(
                                "[FEWFEED] Scheduling for:",
                                scheduledTime.toISOString(),
                            );
                        }

                        // Get fb_dtsg for GraphQL scheduling
                        const fbDtsg = localStorage.getItem("fewfeed_fbDtsg");

                        // Get mode-specific form values
                        const primaryTextEl = els.primaryText;
                        const isLinkMode = mode === "link";

                        // Compress image before upload to avoid 413 error
                        let imageToUpload = state.selectedImage;
                        if (imageToUpload && imageToUpload.startsWith("data:")) {
                            imageToUpload = await compressImage(imageToUpload, 1200, 0.8);
                        }

                        const response = await fetch("/api/publish", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                imageUrl: imageToUpload,
                                linkUrl: isLinkMode ? linkUrl.value : "",
                                linkName: isLinkMode ? linkName.value : "",
                                caption: isLinkMode ? caption.value : "",
                                description: isLinkMode
                                    ? "à¸žà¸´à¸à¸±à¸” : " + description.value
                                    : "",
                                primaryText: primaryTextEl
                                    ? primaryTextEl.value
                                    : "",
                                postMode: mode,
                                accessToken: adsToken, // Ads Token (server fetches Page Token from this)
                                cookieData: cookie,
                                pageId: pageId,
                                adAccountId: adAccountId,
                                fbDtsg: fbDtsg, // Required for GraphQL scheduling
                                scheduledTime: scheduledTime
                                    ? Math.floor(scheduledTime.getTime() / 1000)
                                    : null, // Unix timestamp
                            }),
                        });

                        // All responses are now streaming (both immediate and scheduled)
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let fullLog = "";

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            const text = decoder.decode(value);
                            fullLog += text;
                            console.log(text);
                        }

                        // Parse result from log
                        const urlMatch = fullLog.match(/"url":"([^"]+)"/);
                        const postIdMatch = fullLog.match(/"postId":"([^"]+)"/);
                        const needsSchedulingMatch = fullLog.match(
                            /"needsScheduling":true/,
                        );
                        const scheduledTimeMatch = fullLog.match(
                            /"scheduledTime":(\d+)/,
                        );

                        if (urlMatch) {
                            lastPublishedUrl = urlMatch[1];
                            const postId = postIdMatch ? postIdMatch[1] : null;

                            if (
                                needsSchedulingMatch &&
                                postId &&
                                scheduledTimeMatch
                            ) {
                                // Server created post, now schedule via extension GraphQL
                                const scheduleTimestamp = parseInt(
                                    scheduledTimeMatch[1],
                                );
                                console.log(
                                    "[FEWFEED] Post created, scheduling via extension GraphQL...",
                                );
                                console.log(
                                    "[FEWFEED] Post ID:",
                                    postId,
                                    "Schedule time:",
                                    scheduleTimestamp,
                                );
                                console.log(
                                    "[FEWFEED] fb_dtsg:",
                                    fbDtsg
                                        ? fbDtsg.substring(0, 20) + "..."
                                        : "(empty)",
                                );

                                if (!fbDtsg) {
                                    throw new Error(
                                        "fb_dtsg is required for scheduling. Please refresh your Facebook login.",
                                    );
                                }


                                // Call extension to schedule via GraphQL
                                window.postMessage(
                                    {
                                        type: "FEWFEED_SCHEDULE_POST_GRAPHQL",
                                        postId: postId,
                                        pageId: pageId,
                                        fbDtsg: fbDtsg,
                                        scheduledTime: scheduleTimestamp,
                                    },
                                    "*",
                                );

                                // Wait for response from extension
                                const scheduleResult = await new Promise(
                                    (resolve) => {
                                        const handler = (event) => {
                                            if (
                                                event.data.type ===
                                                "FEWFEED_SCHEDULE_POST_GRAPHQL_RESPONSE"
                                            ) {
                                                window.removeEventListener(
                                                    "message",
                                                    handler,
                                                );
                                                resolve(event.data.data);
                                            }
                                        };
                                        window.addEventListener(
                                            "message",
                                            handler,
                                        );
                                        // Timeout after 30s
                                        setTimeout(() => {
                                            window.removeEventListener(
                                                "message",
                                                handler,
                                            );
                                            resolve({
                                                success: false,
                                                error: "Extension scheduling timeout",
                                            });
                                        }, 30000);
                                    },
                                );

                                if (scheduleResult.success) {
                                    els.publishBtn.textContent = "âœ“";
                                    els.publishBtn.classList.add("published");
                                    els.publishBtn.disabled = false;
                                    console.log(
                                        "[FEWFEED] Post scheduled via GraphQL:",
                                        lastPublishedUrl,
                                    );

                                    // Invalidate cache after successful schedule
                                    invalidatePostsCache(getCurrentPageId());

                                    // Refresh scheduled times after posting
                                    if (scheduledTime) {
                                        await refreshScheduledPostTimes();
                                        updateNextScheduleDisplay();
                                    }

                                    // Navigate to pending page after 1 second, then clear image silently
                                    setTimeout(() => {
                                        window.location.hash = "#pending";
                                        handleNavigation();
                                        // Clear the uploaded image after navigation
                                        state.selectedImage = null;
                                        state.currentView = "upload";
                                        if (els.fullImageView) els.fullImageView.style.display = "none";
                                        if (els.uploadPrompt) els.uploadPrompt.style.display = "flex";
                                        els.publishBtn.textContent = "SCHEDULE";
                                        els.publishBtn.classList.remove("published");
                                    }, 1000);
                                } else {
                                    throw new Error(
                                        `GraphQL scheduling failed: ${scheduleResult.error}`,
                                    );
                                }
                            } else {
                                // Immediate publish success
                                els.publishBtn.textContent = "âœ“";
                                els.publishBtn.classList.add("published");
                                els.publishBtn.disabled = false;
                                console.log(
                                    "[FEWFEED] Published successfully:",
                                    lastPublishedUrl,
                                );
                            }
                        } else if (fullLog.includes('"success":false')) {
                            // Extract error message from response - show the actual error
                            const errorMatch =
                                fullLog.match(/"error":"([^"]+)"/);
                            const errorMsg = errorMatch
                                ? errorMatch[1]
                                : "Unknown error";
                            console.error("[FEWFEED] Full error log:", fullLog);
                            throw new Error(errorMsg);
                        } else {
                            // No success or error found - unexpected response
                            console.error(
                                "[FEWFEED] Unexpected response:",
                                fullLog,
                            );
                            throw new Error("Unexpected response from server");
                        }
                    } catch (err) {
                        console.error("[FEWFEED] Error:", err.message);
                        alert("Publish failed: " + err.message);
                        els.publishBtn.textContent = "SCHEDULE";
                        els.publishBtn.disabled = false;
                    }
                });
            }

            // Setup publish handlers for all modes
            setupPublishHandler("link");
            setupPublishHandler("image");
            setupPublishHandler("reels");

            // Load config
            fetch("/api/config")
                .then((res) => res.json())
                .then((config) => {
                    if (config.defaults) {
                        // linkUrl stays empty - user will paste
                        if (config.defaults.caption) {
                            caption.value = config.defaults.caption;
                            previewCaption.textContent =
                                config.defaults.caption;
                        }
                        if (config.defaults.description) {
                            description.value = config.defaults.description;
                            previewDescription.textContent =
                                config.defaults.description;
                        }
                    }
                    // Set page and ad account from server config
                    if (config.pageId) {
                        document.getElementById("pageSelect").value =
                            config.pageId;
                        document.getElementById("previewPageId").textContent =
                            config.pageId;
                    }
                    if (config.adAccountId) {
                        document.getElementById("adAccountSelect").value =
                            config.adAccountId;
                    }
                })
                .catch(() => {});

            // ===== FEWFEED Extension Integration =====
            let fbCookie = null;
            let fbToken = null; // Ads Token (for creating ad creatives)
            let fbPostToken = null; // Post Token from Postcron (for fetching pages)
            let allPages = [];
            let selectedPageIndex = 0;

            // Page selector elements
            const pageSelector = document.getElementById("pageSelector");
            const pageDropdown = document.getElementById("pageDropdown");

            // Toggle dropdown
            pageSelector.addEventListener("click", (e) => {
                e.stopPropagation();
                pageDropdown.classList.toggle("visible");
            });

            // Close dropdown when clicking outside
            document.addEventListener("click", () => {
                pageDropdown.classList.remove("visible");
            });

            // Select a page
            function selectPage(index) {
                selectedPageIndex = index;
                const page = allPages[index];
                if (!page) return;

                console.log(
                    "[FEWFEED] Selected page:",
                    page.name,
                    "id:",
                    page.id,
                    "hasPageToken:",
                    !!page.access_token,
                );

                // Store Page Access Token for this specific page (for scheduled posts API)
                if (page.access_token) {
                    localStorage.setItem(
                        "fewfeed_selectedPageToken",
                        page.access_token,
                    );
                    console.log(
                        "[FEWFEED] Stored Page Access Token for scheduled posts",
                    );
                }

                // Hide skeleton, show real selector
                const skeleton = document.getElementById(
                    "pageSelectorSkeleton",
                );
                const pageSelector = document.getElementById("pageSelector");
                if (skeleton) skeleton.style.display = "none";
                pageSelector.style.display = "flex";

                // Update content
                document.getElementById("previewPageName").textContent =
                    page.name || "Page";
                document.getElementById("previewPageId").textContent = page.id;
                document.getElementById("pageSelect").value = page.id;

                const imgUrl =
                    page.picture?.data?.url ||
                    `https://graph.facebook.com/${page.id}/picture?type=small`;
                document.getElementById("previewAvatarImg").src = imgUrl;

                // Update dropdown selection
                document
                    .querySelectorAll(".page-dropdown-item")
                    .forEach((item, i) => {
                        item.classList.toggle("selected", i === index);
                    });

                pageDropdown.classList.remove("visible");

                // Load page-specific settings
                loadSettings();

                // If on settings page, reload settings panel
                if (window.location.hash === "#settings" && settingsPanel.style.display === "flex") {
                    loadSettingsPanel();
                }

                // If on pending panel, refresh scheduled posts for new page
                if (pendingPanel.style.display === "block") {
                    showPendingPanel();
                }
            }

            // Render pages dropdown
            function renderPagesDropdown(pages) {
                allPages = pages;
                pageDropdown.textContent = "";

                pages.forEach((page, i) => {
                    const item = document.createElement("div");
                    item.className =
                        "page-dropdown-item" +
                        (i === selectedPageIndex ? " selected" : "");

                    const img = document.createElement("img");
                    img.src =
                        page.picture?.data?.url ||
                        `https://graph.facebook.com/${page.id}/picture?type=small`;
                    img.alt = page.name;

                    const info = document.createElement("div");
                    info.className = "page-dropdown-item-info";

                    const name = document.createElement("h4");
                    name.textContent = page.name || "Page";

                    const id = document.createElement("p");
                    id.textContent = page.id;

                    info.appendChild(name);
                    info.appendChild(id);
                    item.appendChild(img);
                    item.appendChild(info);

                    item.addEventListener("click", () => selectPage(i));
                    pageDropdown.appendChild(item);
                });

                // Auto-select first page
                if (pages.length > 0) {
                    selectPage(0);
                }
            }

            // Listen for data injection from extension
            window.addEventListener("message", (event) => {
                if (event.source !== window) return;

                // Extension ready
                if (event.data.type === "FEWFEED_EXTENSION_READY") {
                    console.log("[FEWFEED] Extension detected!");
                    document.body.setAttribute("data-extension-ready", "true");
                }

                // Cookie + Tokens injected from extension
                if (event.data.type === "FEWFEED_COOKIE_INJECTED") {
                    fbCookie = event.data.cookie;
                    fbToken = event.data.token;
                    fbPostToken = event.data.postToken;
                    const userId = event.data.userId;
                    const userName = event.data.userName;

                    console.log("[FEWFEED] Data received:", {
                        userId: userId,
                        userName: userName,
                        hasAdsToken: !!fbToken,
                        hasPostToken: !!fbPostToken,
                        hasCookie: !!fbCookie,
                    });

                    // Show status with token/cookie indicators
                    showCookieStatus(
                        true,
                        userId,
                        userName,
                        !!fbToken,
                        !!fbCookie,
                        !!fbPostToken,
                    );

                    // Fetch pages - prefer Post Token (works better for me/accounts), fallback to Ads Token
                    if (fbPostToken || fbToken) {
                        fetchPages(fbPostToken || fbToken);
                    }
                }

                // Pages response from extension
                if (event.data.type === "FEWFEED_PAGES_RESPONSE") {
                    const response = event.data.data;
                    if (
                        response.success &&
                        response.pages &&
                        response.pages.length > 0
                    ) {
                        renderPagesDropdown(response.pages);
                        console.log(
                            "[FEWFEED] Pages loaded:",
                            response.pages.length,
                        );
                        // Re-trigger navigation in case we landed on #pending before pages were loaded
                        if (window.location.hash === "#pending") {
                            handleNavigation();
                        }
                    }
                }

                // Post token arrived from Postcron OAuth
                if (event.data.type === "FEWFEED_POST_TOKEN_READY") {
                    fbPostToken = event.data.postToken;
                    console.log("[FEWFEED] Post token received!");
                    localStorage.setItem("fewfeed_postToken", fbPostToken);

                    // Update UI status
                    const userName = localStorage.getItem("fewfeed_userName");
                    const userId = localStorage.getItem("fewfeed_userId");
                    showCookieStatus(
                        true,
                        userId,
                        userName,
                        !!fbToken,
                        !!fbCookie,
                        !!fbPostToken,
                    );

                    // If we don't have pages yet, fetch them with the new post token
                    if (allPages.length === 0 && fbPostToken) {
                        fetchPages(fbPostToken);
                    }
                }
            });

            // Fetch pages from Facebook API via extension or direct call
            function fetchPages(accessToken) {
                // Determine if this is Post Token (starts with EAAChZC from Postcron) or Ads Token (starts with EAABsbCS)
                const tokenType = accessToken?.startsWith("EAAChZC")
                    ? "POST_TOKEN"
                    : accessToken?.startsWith("EAABsbCS")
                      ? "ADS_TOKEN"
                      : "UNKNOWN";
                console.log(
                    "[FEWFEED] fetchPages called with:",
                    tokenType,
                    "token starts with:",
                    accessToken?.substring(0, 10) + "...",
                );

                // Try extension first
                window.postMessage(
                    {
                        type: "FEWFEED_FETCH_PAGES",
                        accessToken: accessToken,
                    },
                    "*",
                );

                // Also try direct API call as fallback (must include access_token field to get Page Tokens)
                fetch(
                    `https://graph.facebook.com/v21.0/me/accounts?access_token=${accessToken}&fields=access_token,id,name,picture,is_published&limit=100`,
                )
                    .then((res) => res.json())
                    .then((data) => {
                        if (data.data && data.data.length > 0) {
                            renderPagesDropdown(data.data);
                            console.log(
                                "[FEWFEED] Pages loaded (direct):",
                                data.data.length,
                            );
                        }
                    })
                    .catch((err) =>
                        console.log(
                            "[FEWFEED] Direct API failed:",
                            err.message,
                        ),
                    );
            }

            // Helper: Show cookie status with Token/Cookie/PostToken indicators in header
            function showCookieStatus(
                connected,
                userId,
                userName,
                hasToken,
                hasCookie,
                hasPostToken = false,
            ) {
                const tokenIndicator =
                    document.getElementById("tokenIndicator");
                const cookieIndicator =
                    document.getElementById("cookieIndicator");
                const postTokenIndicator =
                    document.getElementById("postTokenIndicator");

                // Update token indicator (Ads Token)
                if (tokenIndicator) {
                    tokenIndicator.classList.remove("valid", "invalid");
                    tokenIndicator.classList.add(
                        hasToken ? "valid" : "invalid",
                    );
                }

                // Update cookie indicator
                if (cookieIndicator) {
                    cookieIndicator.classList.remove("valid", "invalid");
                    cookieIndicator.classList.add(
                        hasCookie ? "valid" : "invalid",
                    );
                }

                // Update post token indicator
                if (postTokenIndicator) {
                    postTokenIndicator.classList.remove("valid", "invalid");
                    postTokenIndicator.classList.add(
                        hasPostToken ? "valid" : "invalid",
                    );
                }

                // Update header avatar with user photo or initial
                if (connected) {
                    const userId = localStorage.getItem("fewfeed_userId");
                    const accessToken = localStorage.getItem(
                        "fewfeed_accessToken",
                    );
                    const avatarImg =
                        document.getElementById("headerAvatarImg");
                    const avatarInitial = document.getElementById(
                        "headerAvatarInitial",
                    );

                    if (userId && accessToken && avatarImg) {
                        const avatarUrl = `https://graph.facebook.com/${userId}/picture?type=normal&width=72&height=72&access_token=${accessToken}`;
                        avatarImg.src = avatarUrl;
                        avatarImg.onload = () => {
                            avatarImg.style.display = "block";
                            if (avatarInitial)
                                avatarInitial.style.display = "none";
                        };
                        avatarImg.onerror = () => {
                            avatarImg.style.display = "none";
                            if (avatarInitial) {
                                avatarInitial.style.display = "flex";
                                avatarInitial.textContent = (userName || "U")
                                    .charAt(0)
                                    .toUpperCase();
                            }
                        };
                    } else if (avatarInitial) {
                        avatarInitial.textContent = (userName || "U")
                            .charAt(0)
                            .toUpperCase();
                    }
                }

                console.log(
                    "[FEWFEED] Status updated - AdsToken:",
                    hasToken ? "valid" : "invalid",
                    "Cookie:",
                    hasCookie ? "valid" : "invalid",
                    "PostToken:",
                    hasPostToken ? "valid" : "invalid",
                );
            }

            // Token Modal Functions
            function openTokenModal(type) {
                const modal = document.getElementById("tokenModal");
                const adsToken =
                    localStorage.getItem("fewfeed_accessToken") ||
                    localStorage.getItem("fewfeed_token") ||
                    "";
                const cookie = localStorage.getItem("fewfeed_cookie") || "";
                const postToken =
                    localStorage.getItem("fewfeed_postToken") || "";

                // Get all token items
                const adsItem = document.getElementById("modalAdsItem");
                const cookieItem = document.getElementById("modalCookieItem");
                const postItem = document.getElementById("modalPostItem");

                // Hide all first
                if (adsItem) adsItem.style.display = "none";
                if (cookieItem) cookieItem.style.display = "none";
                if (postItem) postItem.style.display = "none";

                // Show only the requested type
                if (type === "ads" && adsItem) {
                    adsItem.style.display = "block";
                    const adsStatus = document.getElementById(
                        "modalAdsTokenStatus",
                    );
                    const adsValue =
                        document.getElementById("modalAdsTokenValue");
                    adsStatus.textContent = adsToken ? "Valid" : "Invalid";
                    adsStatus.className =
                        "token-status " + (adsToken ? "valid" : "invalid");
                    adsValue.textContent = adsToken || "(No Ads Token)";
                    adsValue.className =
                        "token-value" + (adsToken ? "" : " empty");
                    document.getElementById("tokenModalTitle").textContent =
                        "Ads Token";
                } else if (type === "cookie" && cookieItem) {
                    cookieItem.style.display = "block";
                    const cookieStatus =
                        document.getElementById("modalCookieStatus");
                    const cookieValue =
                        document.getElementById("modalCookieValue");
                    cookieStatus.textContent = cookie ? "Valid" : "Invalid";
                    cookieStatus.className =
                        "token-status " + (cookie ? "valid" : "invalid");
                    cookieValue.textContent = cookie || "(No Cookie)";
                    cookieValue.className =
                        "token-value" + (cookie ? "" : " empty");
                    document.getElementById("tokenModalTitle").textContent =
                        "Cookie";
                } else if (type === "post" && postItem) {
                    postItem.style.display = "block";
                    const postStatus = document.getElementById(
                        "modalPostTokenStatus",
                    );
                    const postValue = document.getElementById(
                        "modalPostTokenValue",
                    );
                    postStatus.textContent = postToken ? "Valid" : "Invalid";
                    postStatus.className =
                        "token-status " + (postToken ? "valid" : "invalid");
                    postValue.textContent = postToken || "(No Post Token)";
                    postValue.className =
                        "token-value" + (postToken ? "" : " empty");
                    document.getElementById("tokenModalTitle").textContent =
                        "Post Token";
                }

                modal.classList.add("show");
            }

            function closeTokenModal() {
                const modal = document.getElementById("tokenModal");
                modal.classList.remove("show");
            }

            function copyToken(type) {
                let value = "";
                let name = "";
                if (type === "ads") {
                    value =
                        localStorage.getItem("fewfeed_accessToken") ||
                        localStorage.getItem("fewfeed_token") ||
                        "";
                    name = "Ads Token";
                } else if (type === "cookie") {
                    value = localStorage.getItem("fewfeed_cookie") || "";
                    name = "Cookie";
                } else if (type === "post") {
                    value = localStorage.getItem("fewfeed_postToken") || "";
                    name = "Post Token";
                }

                if (value) {
                    navigator.clipboard
                        .writeText(value)
                        .then(() => {
                            alert(name + " copied!");
                        })
                        .catch((err) => {
                            console.error("Failed to copy:", err);
                            // Fallback for older browsers
                            const textarea = document.createElement("textarea");
                            textarea.value = value;
                            document.body.appendChild(textarea);
                            textarea.select();
                            document.execCommand("copy");
                            document.body.removeChild(textarea);
                            alert(name + " copied!");
                        });
                } else {
                    alert("No " + name + " available");
                }
            }

            // Setup click handlers for status indicators
            function setupTokenModalHandlers() {
                const tokenIndicator =
                    document.getElementById("tokenIndicator");
                const cookieIndicator =
                    document.getElementById("cookieIndicator");
                const postTokenIndicator =
                    document.getElementById("postTokenIndicator");
                const modalOverlay = document.getElementById("tokenModal");

                if (tokenIndicator)
                    tokenIndicator.addEventListener("click", () =>
                        openTokenModal("ads"),
                    );
                if (cookieIndicator)
                    cookieIndicator.addEventListener("click", () =>
                        openTokenModal("cookie"),
                    );
                if (postTokenIndicator)
                    postTokenIndicator.addEventListener("click", () =>
                        openTokenModal("post"),
                    );

                // Close modal when clicking outside
                if (modalOverlay) {
                    modalOverlay.addEventListener("click", (e) => {
                        if (e.target === modalOverlay) closeTokenModal();
                    });
                }

                // Close modal with Escape key
                document.addEventListener("keydown", (e) => {
                    if (e.key === "Escape") closeTokenModal();
                });
            }

            // Initialize modal handlers when DOM is ready
            if (document.readyState === "loading") {
                document.addEventListener(
                    "DOMContentLoaded",
                    setupTokenModalHandlers,
                );
            } else {
                setupTokenModalHandlers();
            }

            // Load saved data from localStorage on page load
            function loadSavedData() {
                const accessToken =
                    localStorage.getItem("fewfeed_accessToken") ||
                    localStorage.getItem("fewfeed_token");
                const postToken = localStorage.getItem("fewfeed_postToken");
                const cookie = localStorage.getItem("fewfeed_cookie");
                const userId = localStorage.getItem("fewfeed_userId");
                const userName = localStorage.getItem("fewfeed_userName");

                if (userId) {
                    console.log(
                        "[FEWFEED] Loaded saved data from localStorage",
                    );
                    fbToken = accessToken;
                    fbPostToken = postToken;
                    fbCookie = cookie;
                    showCookieStatus(
                        true,
                        userId,
                        userName,
                        !!accessToken,
                        !!cookie,
                        !!postToken,
                    );

                    // Fetch pages - prefer Post Token, fallback to Ads Token
                    if (postToken || accessToken) {
                        fetchPages(postToken || accessToken);
                    }
                }
            }

            // Load on startup
            loadSavedData();

            // Lightbox functionality - get elements on demand since they're after the script
            window.showLightbox = function (src) {
                const lightboxOverlay = document.getElementById("lightboxOverlay");
                const lightboxImage = document.getElementById("lightboxImage");
                if (lightboxImage && lightboxOverlay) {
                    lightboxImage.src = src;
                    lightboxOverlay.classList.add("show");
                }
            };

            window.closeLightbox = function () {
                const lightboxOverlay = document.getElementById("lightboxOverlay");
                if (lightboxOverlay) {
                    lightboxOverlay.classList.remove("show");
                }
            };

            // Setup lightbox event listeners after DOM ready
            document.addEventListener("DOMContentLoaded", () => {
                const lightboxOverlay = document.getElementById("lightboxOverlay");
                if (lightboxOverlay) {
                    lightboxOverlay.addEventListener("click", (e) => {
                        if (e.target === lightboxOverlay) {
                            closeLightbox();
                        }
                    });
                }
            });

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                    closeLightbox();
                }
            });

        </script>

        <!-- Lightbox Modal -->
        <div class="lightbox-overlay" id="lightboxOverlay">
            <button class="lightbox-close" onclick="closeLightbox()">
                &times;
            </button>
            <img class="lightbox-image" id="lightboxImage" src="" alt="" />
        </div>

    </body>
</html>
